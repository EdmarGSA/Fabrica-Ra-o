import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  signInWithCustomToken,
  signInAnonymously,
  sendEmailVerification,
  updatePassword,
  sendPasswordResetEmail,
  EmailAuthProvider,
  reauthenticateWithCredential,
} from 'firebase/auth';
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  onSnapshot,
  doc,
  updateDoc,
  deleteDoc,
  setDoc,
  getDoc,
  query,
  where,
} from 'firebase/firestore';

// Importar ícones do Lucide React
import { Home, Package, Wheat, Truck, Users, ArrowLeftRight, Plus, Edit, Trash2, Save, X, Search, Info, Factory, Loader2, ShoppingCart, DollarSign, UserCheck, Clock, CheckCircle, XCircle, AlertTriangle, Box, LogOut, UserPlus, UserCog, Eye, EyeOff, Settings } from 'lucide-react';

// Variáveis globais para Firebase (fornecidas pelo ambiente Canvas)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Configuração para Firebase. apiKey deve ser uma string vazia para o Canvas injetar a chave correta.
// authDomain e projectId DEVEM vir de __firebase_config, pois são específicos do projeto Firebase do ambiente Canvas.
let firebaseConfig = {
  apiKey: "", // DEVE SER UMA STRING VAZIA para o Canvas injetar a chave correta.
  // Os valores a seguir serão substituídos por __firebase_config se disponíveis
  authDomain: "default-auth-domain.firebaseapp.com", // Placeholder
  projectId: "default-project-id", // Placeholder
  storageBucket: "default-storage-bucket.appspot.com", // Placeholder
  messagingSenderId: "default-messaging-sender-id", // Placeholder

  // No ambiente Canvas, o appId e measurementId são gerenciados pelo sistema e não precisam ser definidos aqui.
  // Eles são injetados via __firebase_config.
  appId: "default-app-id", // Placeholder, será sobrescrito
  measurementId: "default-measurement-id" // Placeholder, será sobrescrito
};

// Usa a configuração do Firebase fornecida pelo ambiente Canvas se disponível
if (typeof __firebase_config !== 'undefined') {
  try {
    const parsedConfig = JSON.parse(__firebase_config);
    // Substitui a configuração padrão pela configuração injetada, garantindo que os valores do Canvas sejam usados
    firebaseConfig = { ...firebaseConfig, ...parsedConfig };
  } catch (e) {
    console.error("Erro ao analisar __firebase_config:", e);
    // Não exibe mensagem para o utilizador aqui, pois o erro será capturado pela inicialização global abaixo
  }
}

let app;
let db;
let auth;
let firebaseGlobalError = null; // Variável para capturar erro de inicialização global

// Inicializa Firebase apenas uma vez e captura erros
try {
  console.log("Tentando inicializar Firebase com a configuração:", firebaseConfig); // Log a configuração final
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
  console.log("Firebase inicializado com sucesso.");
  console.log("App ID em uso (runtime):", appId); // Para depuração
} catch (error) {
  console.error("Erro ao inicializar Firebase globalmente:", error);
  firebaseGlobalError = error; // Armazena o erro para ser exibido no componente
}


function App() {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [currentUser, setCurrentUser] = useState(null); // Armazena o objeto de utilizador do Firebase Auth
  const [userId, setUserId] = useState(null); // Armazena o UID do utilizador
  const [userRole, setUserRole] = useState(null); // Armazena o perfil do utilizador ('admin', 'producao', etc.)
  const [isAuthReady, setIsAuthReady] = useState(false); // Indica se a autenticação inicial foi verificada
  const [isLoading, setIsLoading] = useState(true); // Estado geral de carregamento do app
  const [showCadastroMenu, setShowCadastroMenu] = useState(false);

  // Estado para exibir erro global de inicialização do Firebase
  const [firebaseInitDisplayError, setFirebaseInitDisplayError] = useState(firebaseGlobalError);


  // Estados para os dados (agora serão carregados do Firestore)
  const [insumos, setInsumos] = useState([]);
  const [produtos, setProdutos] = useState([]);
  const [fornecedores, setFornecedores] = useState([]);
  const [clientes, setClientes] = useState([]);
  const [formulas, setFormulas] = useState([]);
  const [ordensProducao, setOrdensProducao] = useState([]);
  const [pedidos, setPedidos] = useState([]);
  const [contasAPagar, setContasAPagar] = useState([]);
  const [contasAReceber, setContasAReceber] = useState([]);
  const [movimentacoes, setMovimentacoes] = useState([]);
  const [allUserProfiles, setAllUserProfiles] = useState([]); // Para GerenciarUsuarios

  // Estados para formulários de edição/criação
  const [editingItem, setEditingItem] = useState(null);
  const [formType, setFormType] = useState('');

  // Estados para o modal de confirmação de exclusão ou produção/pedido
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [confirmModalMessage, setConfirmModalMessage] = useState('');
  const [confirmModalAction, setConfirmModalAction] = useState(() => () => {});

  // Estados para o item a ser excluído ou ordem a ser confirmada
  const [itemToDelete, setItemToDelete] = useState(null);
  const [typeToDelete, setTypeToDelete] = useState('');
  const [orderToConfirm, setOrderToConfirm] = useState(null);
  const [pedidoToConfirm, setPedidoToConfirm] = useState(null);
  const [contaToConfirm, setContaToConfirm] = useState(null);
  const [contaTypeToConfirm, setContaTypeToConfirm] = useState('');

  // Estados para o modal de mensagem (sucesso/erro)
  const [showMessageModal, setShowMessageModal] = useState(false);
  const [messageModalContent, setMessageModalContent] = useState({ title: '', message: '', type: 'info' });

  // Estados para modals de autenticação (alterar senha, esqueci senha)
  const [showChangePasswordModal, setShowChangePasswordModal] = useState(false);
  const [showForgotPasswordModal, setShowForgotPassword] = useState(false);


  // Efeito para observar o estado de autenticação
  useEffect(() => {
    // Se houve um erro na inicialização global do Firebase, não prossegue
    if (firebaseInitDisplayError) {
      setIsLoading(false);
      setIsAuthReady(true);
      return;
    }

    if (!auth) {
      showAppMessage('Erro de Inicialização', 'Firebase Auth não foi inicializado. Verifique a configuração.', 'error');
      setIsLoading(false);
      setIsAuthReady(true);
      return;
    }

    // Lógica para realizar o login inicial (anónimo ou com token)
    const performInitialSignIn = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
          console.log("Login inicial: Autenticado com token personalizado.");
        } else {
          // Apenas faz login anónimo se nenhum token personalizado for fornecido E nenhum utilizador estiver atualmente logado
          if (!auth.currentUser) {
            await signInAnonymously(auth);
            console.log("Login inicial: Autenticado anonimamente.");
          } else {
            console.log("Login inicial: Já existe um utilizador logado.");
          }
        }
      } catch (error) {
        console.error("Erro ao realizar login inicial:", error);
        showAppMessage('Erro de Autenticação Inicial', `Não foi possível autenticar. Detalhes: ${error.message}`, 'error');
        setIsLoading(false); // Garante que o carregamento pare em caso de erro de login inicial
        setIsAuthReady(true);
      }
    };

    // Chama a função de login inicial
    // Chama o login inicial apenas se a autenticação não estiver pronta ou se não houver utilizador logado
    if (!isAuthReady || !auth.currentUser) {
      performInitialSignIn();
    }


    // Listener para mudanças no estado de autenticação
    const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
      console.log("onAuthStateChanged disparado. Utilizador:", user ? user.uid : "null", "Email Verificado:", user ? user.emailVerified : "N/A"); // Log para depuração
      if (user) {
        // Novo: Verifica se o e-mail foi verificado (apenas para utilizadores com e-mail, não anónimos)
        if (user.email && !user.emailVerified) {
          console.log("Email não verificado para o utilizador:", user.email);
          // Se o utilizador tentar fazer login antes de verificar, desloga e mostra mensagem
          await signOut(auth); // Desloga o utilizador
          showAppMessage('Verificação de E-mail Necessária', 'Por favor, verifique seu e-mail para fazer login. Um link de verificação foi enviado. Se não recebeu, clique em "Reenviar E-mail de Verificação" na tela de login.', 'info');
          setCurrentUser(null); // Garante que o estado do utilizador seja limpo
          setUserId(null);
          setUserRole(null);
          setIsLoading(false);
          setIsAuthReady(true);
          return; // Interrompe o fluxo para utilizadores não verificados
        }

        setCurrentUser(user);
        setUserId(user.uid);
        try {
          // Usando o appId do ambiente Canvas para o caminho do perfil
          const userProfileRef = doc(db, `artifacts/${appId}/userProfiles`, user.uid);
          const userProfileSnap = await getDoc(userProfileRef);
          console.log("Snapshot do perfil do utilizador existe?", userProfileSnap.exists()); // Log de depuração
          if (userProfileSnap.exists()) {
            setUserRole(userProfileSnap.data().role);
            console.log("Perfil do utilizador encontrado. Papel:", userProfileSnap.data().role); // Log para depuração
            // AGORA: Define isLoading como false assim que o utilizador e o perfil são carregados.
            // O carregamento de dados subsequente será tratado pelo segundo useEffect.
            setIsLoading(false);
          } else {
            console.warn("Perfil de utilizador não encontrado para UID:", user.uid);
            setUserRole(null); // Define como null se o perfil não for encontrado
            showAppMessage('Perfil Ausente', 'Seu perfil de utilizador não foi encontrado. Por favor, entre em contacto com o administrador.', 'error');
            await signOut(auth); // Força o logout se o perfil não for encontrado
            setIsLoading(false); // Garante que o carregamento pare se o perfil estiver faltando e o logout ocorrer
          }
        } catch (error) {
          console.error("Erro ao buscar perfil do utilizador:", error);
          showAppMessage('Erro de Perfil', `Não foi possível carregar seu perfil. Detalhes: ${error.message}`, 'error');
          setUserRole(null); // Define como null em caso de erro
          await signOut(auth); // Força o logout em caso de erro ao buscar o perfil
          setIsLoading(false); // Garante que o carregamento pare em caso de erro no perfil e o logout ocorra
        } finally {
          setIsAuthReady(true); // O estado de autenticação é conhecido
          console.log("isAuthReady definido para true."); // Log para depuração
          // Se o utilizador estiver logado mas o userRole ainda for null (perfil não encontrado ou erro),
          // garante que isLoading seja false para que a tela de erro seja exibida.
          if (user && userRole === null) {
            setIsLoading(false);
          }
        }
      } else {
        // Nenhum utilizador logado
        console.log("Nenhum utilizador logado. Redefinindo estados."); // Log para depuração
        setCurrentUser(null);
        setUserId(null);
        setUserRole(null);
        setIsAuthReady(true); // O estado de autenticação é conhecido (nenhum utilizador)
        setIsLoading(false); // Nenhum utilizador, então nenhum dado para carregar, o carregamento está completo.
      }
    });

    return () => unsubscribeAuth();
  }, [firebaseInitDisplayError]); // Adicionada dependência para reagir a erros de inicialização

  // Efeito para carregar dados do Firestore (com listeners em tempo real)
  useEffect(() => {
    console.log("useEffect de carregamento de dados disparado. userId:", userId, "userRole:", userRole, "isAuthReady:", isAuthReady, "db initialized:", !!db); // Novo log
    // Apenas procede se a autenticação estiver pronta e um utilizador estiver logado com um papel determinado.
    if (!isAuthReady || !userId || userRole === null || !db) {
      console.log("Condições para carregamento de dados não satisfeitas. Saindo do useEffect de dados."); // Novo log
      // Se db não está inicializado, e a autenticação está pronta, exibe uma mensagem de erro.
      if (!db && isAuthReady) {
        showAppMessage('Erro de Conexão', 'Não foi possível conectar ao banco de dados Firestore. Verifique sua conexão e configuração.', 'error');
      }
      return;
    }

    // Não definimos isLoading aqui, pois ele já foi tratado pelo useEffect de autenticação
    // para permitir a transição da UI. O carregamento de dados agora é "em segundo plano"
    // ou para popular os componentes conforme eles aparecem.

    const collectionPaths = {
      insumos: `artifacts/${appId}/users/${userId}/insumos`,
      produtos: `artifacts/${appId}/users/${userId}/produtos`,
      fornecedores: `artifacts/${appId}/users/${userId}/fornecedores`,
      clientes: `artifacts/${appId}/users/${userId}/clientes`,
      formulas: `artifacts/${appId}/users/${userId}/formulas`,
      ordensProducao: `artifacts/${appId}/users/${userId}/ordensProducao`,
      pedidos: `artifacts/${appId}/users/${userId}/pedidos`,
      contasAPagar: `artifacts/${appId}/users/${userId}/contasAPagar`,
      contasAReceber: `artifacts/${appId}/users/${userId}/contasAReceber`,
      movimentacoes: `artifacts/${appId}/users/${userId}/movimentacoes`,
    };

    let collectionsToLoadCount = Object.keys(collectionPaths).length;
    if (userRole === 'admin') collectionsToLoadCount++; // Adiciona userProfiles se for admin

    // Se não houver coleções para carregar (ex: um novo utilizador sem dados ainda),
    // este useEffect simplesmente retornará, pois isLoading já é false.
    if (collectionsToLoadCount === 0) {
      console.log("Nenhuma coleção para carregar, carregamento de dados concluído.");
      return; // Sai cedo, pois não há nada para ouvir
    }

    const unsubscribes = [];
    let completedSnapshots = 0;

    const handleSnapshotCompletion = () => {
      completedSnapshots++;
      console.log(`Snapshot concluído. Restantes: ${collectionsToLoadCount - completedSnapshots}`);
      // Este contador é mais para depuração ou para um estado de "dados carregados" mais granular,
      // não mais para controlar a tela de carregamento inicial do app.
    };

    Object.keys(collectionPaths).forEach(key => {
      const colPath = collectionPaths[key];
      console.log(`A tentar ouvir a coleção: ${colPath}`); // Log o caminho completo
      const colRef = collection(db, colPath);
      const unsubscribe = onSnapshot(colRef, (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (key === 'insumos') setInsumos(data);
        if (key === 'produtos') setProdutos(data);
        if (key === 'fornecedores') setFornecedores(data);
        if (key === 'clientes') setClientes(data);
        if (key === 'formulas') setFormulas(data);
        if (key === 'ordensProducao') setOrdensProducao(data);
        if (key === 'pedidos') setPedidos(data);
        if (key === 'contasAPagar') setContasAPagar(data);
        if (key === 'contasAReceber') setContasAReceber(data);
        if (key === 'movimentacoes') setMovimentacoes(data);
        handleSnapshotCompletion();
      }, (error) => {
        console.error(`Erro ao carregar ${key} do Firestore (caminho: ${colPath}):`, error); // Log caminho no erro
        showAppMessage('Erro de Sincronização', `Não foi possível carregar os dados de ${key}. Detalhes: ${error.message}`, 'error');
        handleSnapshotCompletion(); // Ainda conta como concluído mesmo em erro
      });
      unsubscribes.push(unsubscribe);
    });

    if (userRole === 'admin') {
      const userProfilesColPath = `artifacts/${appId}/userProfiles`;
      console.log(`A tentar ouvir a coleção de perfis de utilizador: ${userProfilesColPath}`); // Log caminho dos perfis de utilizador
      const userProfilesColRef = collection(db, userProfilesColPath);
      const unsubscribeProfiles = onSnapshot(userProfilesColRef, (snapshot) => {
        const profiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setAllUserProfiles(profiles);
        handleSnapshotCompletion();
      }, (error) => {
        console.error("Erro ao carregar perfis de utilizador:", error);
        showAppMessage('Erro de Sincronização', `Não foi possível carregar os perfis de utilizador. Detalhes: ${error.message}`, 'error');
        handleSnapshotCompletion(); // Ainda conta como concluído mesmo em erro
      });
      unsubscribes.push(unsubscribeProfiles);
    }

    return () => {
      console.log("Limpando subscrições do Firestore.");
      unsubscribes.forEach(unsub => unsub());
    };
  }, [isAuthReady, userId, userRole, db]); // Adicionado db às dependências, pois é usado dentro

  // Funções CRUD com Firestore
  const addItem = async (type, newItem) => {
    try {
      if (!userId) {
        showAppMessage('Erro de Autenticação', 'Utilizador não autenticado. Não é possível adicionar dados.', 'error');
        return;
      }
      const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/${type}s`);
      console.log(`Adicionando item a: artifacts/${appId}/users/${userId}/${type}s`); // Log caminho para adicionar
      await addDoc(collectionRef, newItem);
      showAppMessage('Sucesso!', `${type.charAt(0).toUpperCase() + type.slice(1)} adicionado com sucesso!`, 'success');
    } catch (error) {
      console.error(`Erro ao adicionar ${type}:`, error);
      showAppMessage('Erro ao Adicionar', `Não foi possível adicionar o ${type}. Detalhes: ${error.message}`, 'error');
    }
  };

  const updateItem = async (type, updatedItem) => {
    try {
      if (!userId) {
        showAppMessage('Erro de Autenticação', 'Utilizador não autenticado. Não é possível atualizar dados.', 'error');
        return;
      }
      const docRef = doc(db, `artifacts/${appId}/users/${userId}/${type}s`, updatedItem.id);
      console.log(`Atualizando item em: artifacts/${appId}/users/${userId}/${type}s/${updatedItem.id}`); // Log caminho para atualizar
      await updateDoc(docRef, updatedItem);
      showAppMessage('Sucesso!', `${type.charAt(0).toUpperCase() + type.slice(1)} atualizado com sucesso!`, 'success');
    } catch (error) {
      console.error(`Erro ao atualizar ${type}:`, error);
      showAppMessage('Erro ao Atualizar', `Não foi possível atualizar o ${type}. Detalhes: ${error.message}`, 'error');
    }
  };

  const deleteItem = async (type, id) => {
    try {
      if (!userId) {
        showAppMessage('Erro de Autenticação', 'Utilizador não autenticado. Não é possível excluir dados.', 'error');
        return;
      }
      const docRef = doc(db, `artifacts/${appId}/users/${userId}/${type}s`, id);
      console.log(`Excluindo item em: artifacts/${appId}/users/${userId}/${type}s/${id}`); // Log caminho para excluir
      await deleteDoc(docRef);
      showAppMessage('Sucesso!', `${type.charAt(0).toUpperCase() + type.slice(1)} excluído com sucesso!`, 'success');
    } catch (error) {
      console.error(`Erro ao excluir ${type}:`, error);
      showAppMessage('Erro ao Excluir', `Não foi possível excluir o ${type}. Detalhes: ${error.message}`, 'error');
    }
  };

  const handleDeleteConfirmed = () => {
    if (itemToDelete && typeToDelete) {
      deleteItem(typeToDelete, itemToDelete.id);
    }
    setShowConfirmModal(false);
    setItemToDelete(null);
    setTypeToDelete('');
  };

  const handleDeleteRequest = (type, item) => {
    setItemToDelete(item);
    setTypeToDelete(type);
    setConfirmModalMessage(`Tem certeza que deseja excluir "${item.nome || item.id || item.descricao}"? Esta ação não pode ser desfeita.`);
    setConfirmModalAction(() => handleDeleteConfirmed);
    setShowConfirmModal(true);
  };

  const handleEdit = (item, type) => {
    setEditingItem(item);
    setFormType(type);
  };

  const handleSave = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newItem = {};
    formData.forEach((value, key) => {
      newItem[key] = key === 'estoque' || key === 'custo' || key === 'preco' || key === 'quantidadeProduzida' || key === 'quantidadeNecessaria' || key === 'quantidade' || key === 'precoUnitario' || key === 'valorTotal' || key === 'valor' ? parseFloat(value) : value;
    });

    if (formType === 'formula') {
      const ingredientes = [];
      const ingredienteIdElements = e.target.elements['ingredienteId'];
      const quantidadeNecessariaElements = e.target.elements['quantidadeNecessaria'];
      const ingredienteUnidadeElements = e.target.elements['ingredienteUnidade'];

      const numIngredientes = ingredienteIdElements ? (ingredienteIdElements.length || 1) : 0;

      if (numIngredientes > 0) {
        if (numIngredientes === 1 && ingredienteIdElements.value !== undefined) {
          ingredientes.push({
            insumoId: ingredienteIdElements.value,
            quantidadePorUnidadeProduto: parseFloat(quantidadeNecessariaElements.value),
            unidade: ingredienteUnidadeElements.value,
          });
        } else {
          for (let i = 0; i < numIngredientes; i++) {
            ingredientes.push({
              insumoId: ingredienteIdElements[i].value,
              quantidadePorUnidadeProduto: parseFloat(quantidadeNecessariaElements[i].value),
              unidade: ingredienteUnidadeElements[i].value,
            });
          }
        }
      }
      newItem.ingredientes = ingredientes;
    } else if (formType === 'pedido') {
        const itens = [];
        const produtoIdElements = e.target.elements['produtoId'];
        const quantidadeElements = e.target.elements['quantidade'];
        const precoUnitarioElements = e.target.elements['precoUnitario'];

        const numItens = produtoIdElements ? (produtoIdElements.length || 1) : 0;

        if (numItens > 0) {
            if (numItens === 1 && produtoIdElements.value !== undefined) {
                itens.push({
                    produtoId: produtoIdElements.value,
                    quantidade: parseFloat(quantidadeElements.value),
                    precoUnitario: parseFloat(precoUnitarioElements.value),
                });
            } else {
                for (let i = 0; i < numItens; i++) {
                    itens.push({
                        produtoId: produtoIdElements[i].value,
                        quantidade: parseFloat(quantidadeElements[i].value),
                        precoUnitario: parseFloat(precoUnitarioElements[i].value),
                    });
                }
            }
        }
        newItem.itens = itens;
        newItem.valorTotal = itens.reduce((sum, item) => sum + (item.quantidade * item.precoUnitario), 0);
        newItem.dataPedido = new Date().toISOString().slice(0, 10);
        newItem.status = 'Pendente';
        newItem.formaPagamento = formData.get('formaPagamento');
        newItem.prazoPagamento = formData.get('prazoPagamento');
    } else if (formType === 'contaPagar') {
        newItem.status = 'Pendente';
    } else if (formType === 'contaReceber') {
        newItem.status = 'Pendente';
    }

    if (editingItem && editingItem.id) {
      updateItem(formType, { ...editingItem, ...newItem });
    } else {
      addItem(formType, newItem);
    }
    setEditingItem(null);
    setFormType('');
  };

  const handleCancel = () => {
    setEditingItem(null);
    setFormType('');
  };

  const showAppMessage = (title, message, type = 'info') => {
    setMessageModalContent({ title, message, type });
    setShowMessageModal(true);
  };

  // Funções de Autenticação
  const handleLogout = async () => {
    try {
      await signOut(auth);
      showAppMessage('Logout', 'Sessão encerrada com sucesso.', 'info');
      setCurrentUser(null);
      setUserId(null);
      setUserRole(null);
      setCurrentPage('login'); // Redireciona para a página de login após o logout
    } catch (error) {
      console.error("Erro ao fazer logout:", error);
      showAppMessage('Erro de Logout', `Não foi possível encerrar a sessão. Detalhes: ${error.message}`, 'error');
    }
  };

  // Componente de Navegação Inferior
  const Navbar = () => (
    <nav className="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-green-600 to-lime-700 p-2 shadow-lg z-50 rounded-t-xl">
      <ul className="flex justify-around items-center h-full">
        {/* Pedidos - Apenas para Admin e Vendas */}
        {(userRole === 'admin' || userRole === 'vendas') && (
          <li>
            <button
              onClick={() => setCurrentPage('pedidos')}
              className={`flex flex-col items-center p-2 rounded-lg transition-all duration-300 ${currentPage === 'pedidos' ? 'bg-white text-green-700 shadow-md' : 'text-white hover:bg-green-700'}`}
            >
              <ShoppingCart size={20} />
              <span className="text-xs mt-1">Pedidos</span>
            </button>
          </li>
        )}
        {/* Produção - Apenas para Admin e Produção */}
        {(userRole === 'admin' || userRole === 'producao') && (
          <li>
            <button
              onClick={() => setCurrentPage('producao')}
              className={`flex flex-col items-center p-2 rounded-lg transition-all duration-300
                ${currentPage === 'producao' ? 'bg-yellow-400 text-green-900 shadow-lg scale-110' : 'text-white hover:bg-green-700'}`} style={{ transform: currentPage === 'producao' ? 'scale(1.1)' : 'scale(1)' }}
            >
              <Factory size={20} />
              <span className="text-xs mt-1">Produção</span>
            </button>
          </li>
        )}
        {/* Financeiro - Apenas para Admin e Financeiro */}
        {(userRole === 'admin' || userRole === 'financeiro') && (
          <li>
            <button
              onClick={() => setCurrentPage('financeiro')}
              className={`flex flex-col items-center p-2 rounded-lg transition-all duration-300 ${currentPage === 'financeiro' ? 'bg-white text-green-700 shadow-md' : 'text-white hover:bg-green-700'}`}
            >
              <DollarSign size={20} />
              <span className="text-xs mt-1">Financeiro</span>
            </button>
          </li>
        )}
        {/* Movimentação - Apenas para Admin */}
        {(userRole === 'admin') && (
          <li>
            <button
              onClick={() => setCurrentPage('movimentacao')}
              className={`flex flex-col items-center p-2 rounded-lg transition-all duration-300 ${currentPage === 'movimentacao' ? 'bg-white text-green-700 shadow-md' : 'text-white hover:bg-green-700'}`}
            >
              <ArrowLeftRight size={20} />
              <span className="text-xs mt-1">Mov.</span>
            </button>
          </li>
        )}
      </ul>
    </nav>
  );

  // Componente de Cabeçalho
  const Header = ({ title }) => (
    <header className="sticky top-0 bg-gradient-to-r from-green-700 to-lime-800 text-white p-4 text-center shadow-md rounded-b-xl z-40 flex justify-between items-center px-4 sm:px-6">
      <button
        onClick={() => {
          setCurrentPage('dashboard');
          setShowCadastroMenu(true);
        }}
        className="text-white hover:text-green-200 transition-colors duration-300 p-2 rounded-lg"
        title="Início e Cadastros"
      >
        <Home size={24} />
      </button>
      <h1 className="text-xl sm:text-2xl font-bold">{title}</h1>
      <div className="flex items-center">
        {userRole && (
          <p className="text-sm mr-2">Perfil: <span className="font-semibold">{userRole.charAt(0).toUpperCase() + userRole.slice(1)}</span></p>
        )}
        {currentUser && (
          <>
            <button
              onClick={() => setShowChangePasswordModal(true)}
              className="text-white hover:text-green-200 transition-colors duration-300 p-2 rounded-lg mr-2"
              title="Configurações de Utilizador"
            >
              <Settings size={20} />
            </button>
            <button
              onClick={handleLogout}
              className="bg-red-500 text-white px-3 py-1 rounded-md shadow-sm hover:bg-red-600 transition-colors duration-300 flex items-center"
              title="Sair"
            >
              <LogOut size={18} className="mr-1" /> Sair
            </button>
          </>
        )}
      </div>
      {userId && (
        <p className="text-xs mt-1 opacity-80 absolute bottom-1 left-1/2 -translate-x-1/2">ID do Utilizador: {userId}</p>
      )}
    </header>
  );

  // Componente de Modal/Formulário
  const FormModal = ({ children, title, onClose }) => (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md animate-fade-in-up overflow-y-auto max-h-[90vh]">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-green-800">{title}</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X size={24} />
          </button>
        </div>
        {children}
      </div>
    </div>
  );

  // Componente de Confirmação
  const ConfirmationModal = ({ message, onConfirm, onCancel }) => (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm animate-fade-in-up text-center">
        <Info size={48} className="mx-auto text-yellow-500 mb-4" />
        <p className="text-lg font-semibold text-gray-800 mb-6">{message}</p>
        <div className="flex justify-center space-x-4">
          <button
            onClick={onCancel}
            className="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300"
          >
            Cancelar
          </button>
          <button
            onClick={onConfirm}
            className="bg-red-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-300"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>
  );

  // Componente de Mensagem (Sucesso/Erro/Info)
  const MessageModal = ({ title, message, type, onClose }) => {
    let icon;
    let bgColor;
    let textColor;

    switch (type) {
      case 'success':
        icon = <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-12 h-12 text-green-500 mx-auto mb-4"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        bgColor = 'bg-green-100';
        textColor = 'text-green-800';
        break;
      case 'error':
        icon = <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-12 h-12 text-red-500 mx-auto mb-4"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12z" /></svg>;
        bgColor = 'bg-red-100';
        textColor = 'text-red-800';
        break;
      case 'info':
      default:
        icon = <Info size={48} className="mx-auto text-blue-500 mb-4" />;
        bgColor = 'bg-blue-100';
        textColor = 'text-blue-800';
        break;
    }

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className={`p-6 rounded-xl shadow-2xl w-full max-w-sm animate-fade-in-up text-center ${bgColor}`}>
          {icon}
          <h3 className={`text-xl font-bold mb-3 ${textColor}`}>{title}</h3>
          <p className={`text-lg mb-6 ${textColor}`}>{message}</p>
          <button
            onClick={onClose}
            className="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300"
          >
            Ok
          </button>
        </div>
      </div>
    );
  };

  // Novo Componente: Menu de Cadastro
  const CadastroMenuModal = ({ onClose }) => {
    const handleNavigate = (page) => {
      setCurrentPage(page);
      onClose();
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md animate-fade-in-up">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-green-800">Cadastros</h2>
            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
              <X size={28} />
            </button>
          </div>
          <div className="grid grid-cols-2 gap-4">
            {/* Insumos - Apenas para Admin */}
            {(userRole === 'admin') && (
              <button
                onClick={() => handleNavigate('insumos')}
                className="flex flex-col items-center p-4 bg-green-100 text-green-800 rounded-lg shadow-sm hover:bg-green-200 transition-colors duration-300"
              >
                <Wheat size={32} className="mb-2" />
                <span className="font-semibold">Insumos</span>
              </button>
            )}
            {/* Produtos - Apenas para Admin e Produção (para ver estoque, mas não editar) */}
            {(userRole === 'admin' || userRole === 'producao') && (
              <button
                onClick={() => handleNavigate('produtos')}
                className="flex flex-col items-center p-4 bg-purple-100 text-purple-800 rounded-lg shadow-sm hover:bg-purple-200 transition-colors duration-300"
              >
                <Package size={32} className="mb-2" />
                <span className="font-semibold">Produtos</span>
              </button>
            )}
            {/* Fornecedores - Apenas para Admin e Financeiro */}
            {(userRole === 'admin' || userRole === 'financeiro') && (
              <button
                onClick={() => handleNavigate('fornecedores')}
                className="flex flex-col items-center p-4 bg-blue-100 text-blue-800 rounded-lg shadow-sm hover:bg-blue-200 transition-colors duration-300"
              >
                <Truck size={32} className="mb-2" />
                <span className="font-semibold">Fornecedores</span>
              </button>
            )}
            {/* Clientes - Apenas para Admin, Vendas e Financeiro */}
            {(userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro') && (
              <button
                onClick={() => handleNavigate('clientes')}
                className="flex flex-col items-center p-4 bg-yellow-100 text-yellow-800 rounded-lg shadow-sm hover:bg-yellow-200 transition-colors duration-300"
              >
                <Users size={32} className="mb-2" />
                <span className="font-semibold">Clientes</span>
              </button>
            )}
            {/* Gerenciar Utilizadores - Apenas para Admin */}
            {(userRole === 'admin') && (
              <button
                onClick={() => handleNavigate('gerenciarUsuarios')}
                className="flex flex-col items-center p-4 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition-colors duration-300"
              >
                <UserCog size={32} className="mb-2" />
                <span className="font-semibold">Gerenciar Utilizadores</span>
              </button>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Função auxiliar para verificar se uma data está atrasada
  const isOverdue = (dueDateString, status) => {
    if (status !== 'Pendente') return false;
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Normaliza para o início do dia
    const dueDate = new Date(dueDateString + 'T00:00:00'); // Garante que a data seja analisada corretamente
    return dueDate < today;
  };

  // Componente Dashboard
  const Dashboard = () => {
    const todayISO = new Date().toISOString().slice(0, 10); // Obtém a data de hoje no formato YYYY-MM-DD

    const totalInsumosEstoque = insumos.reduce((sum, item) => sum + item.estoque, 0);
    const totalProdutosEstoque = produtos.reduce((sum, item) => sum + item.estoque, 0);

    const topInsumos = [...insumos].sort((a, b) => b.estoque - a.estoque).slice(0, 3);
    const maxInsumoEstoque = Math.max(...topInsumos.map(item => item.estoque), 1);

    const topProdutos = [...produtos].sort((a, b) => b.estoque - a.estoque).slice(0, 3);
    const maxProdutoEstoque = Math.max(...topProdutos.map(item => item.estoque), 1);

    // Lógica para Clientes Ativos/Inativos e Clientes em Atraso
    const getClientActivityAndOverdueSummary = () => {
      let activeClientsCount = 0;
      let inactiveClientsCount = 0;
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      // Mapa para armazenar a última data do pedido para cada cliente
      const clientLastOrderDates = new Map();
      pedidos.forEach(pedido => {
        const orderDate = new Date(pedido.dataPedido);
        if (!clientLastOrderDates.has(pedido.clienteId) || orderDate > clientLastOrderDates.get(pedido.clienteId)) {
          clientLastOrderDates.set(pedido.clienteId, orderDate);
        }
      });

      clientes.forEach(client => {
        const lastOrderDate = clientLastOrderDates.get(client.id);
        if (lastOrderDate && lastOrderDate >= thirtyDaysAgo) {
          activeClientsCount++;
        } else {
          inactiveClientsCount++;
        }
      });

      // Calcula clientes em atraso e valor total em atraso
      const overdueClientsMap = new Map(); // clienteId -> valor total em atraso
      contasAReceber.forEach(conta => {
        if (isOverdue(conta.dataVencimento, conta.status)) {
          const currentOverdue = overdueClientsMap.get(conta.clienteId) || 0;
          overdueClientsMap.set(conta.clienteId, currentOverdue + conta.valor);
        }
      });

      const totalOverdueClients = overdueClientsMap.size;
      const totalOverdueValue = Array.from(overdueClientsMap.values()).reduce((sum, val) => sum + val, 0);

      return {
        activeClientsCount,
        inactiveClientsCount,
        totalOverdueClients,
        totalOverdueValue,
      };
    };

    const { activeClientsCount, inactiveClientsCount, totalOverdueClients, totalOverdueValue } = getClientActivityAndOverdueSummary();

    // Lógica para Consumo de Insumos e Alerta de Estoque
    const getInsumoStockAlerts = () => {
      const today = new Date();
      const sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 7);

      const insumoConsumptionLast7Days = {}; // { insumoId: totalConsumedQuantity }

      // Calcula o consumo de ordens de produção concluídas nos últimos 7 dias
      ordensProducao.forEach(order => {
        if (order.status === 'Concluído' && order.dataConclusao) {
          const completionDate = new Date(order.dataConclusao + 'T00:00:00');
          if (completionDate >= sevenDaysAgo && completionDate <= today) {
            const formula = formulas.find(f => f.id === order.formulaId);
            if (formula && formula.ingredientes) {
              formula.ingredientes.forEach(ingrediente => {
                const consumedAmount = ingrediente.quantidadePorUnidadeProduto * order.quantidadeProduzida;
                insumoConsumptionLast7Days[ingrediente.insumoId] = (insumoConsumptionLast7Days[ingrediente.insumoId] || 0) + consumedAmount;
              });
            }
          }
        }
      });

      const insufficientInsumos = [];

      insumos.forEach(insumo => {
        const consumedQty = insumoConsumptionLast7Days[insumo.id] || 0;
        const dailyConsumption = consumedQty / 7; // Consumo diário médio nos últimos 7 dias
        const projectedConsumptionNext7Days = dailyConsumption * 7; // Projeção para os próximos 7 dias

        if (insumo.estoque < projectedConsumptionNext7Days) {
          insufficientInsumos.push({
            ...insumo,
            projectedConsumption: projectedConsumptionNext7Days,
            consumptionRate: dailyConsumption,
          });
        }
      });

      return insufficientInsumos;
    };

    const insufficientInsumos = getInsumoStockAlerts();

    // Nova lógica para Venda de Produtos e Alerta de Estoque
    const getProdutoStockAlerts = () => {
      const today = new Date();
      const sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 7);

      const productSalesLast7Days = {}; // { productId: totalSoldQuantity }

      // Calcula as vendas de pedidos concluídos nos últimos 7 dias
      pedidos.forEach(pedido => {
        if (pedido.status === 'Concluído' && pedido.dataConclusao) { // Assumindo que dataConclusao é definida na conclusão
          const completionDate = new Date(pedido.dataConclusao + 'T00:00:00');
          if (completionDate >= sevenDaysAgo && completionDate <= today) {
            if (pedido.itens) {
              pedido.itens.forEach(item => {
                productSalesLast7Days[item.produtoId] = (productSalesLast7Days[item.produtoId] || 0) + item.quantidade;
              });
            }
          }
        }
      });

      const insufficientProdutos = [];

      produtos.forEach(produto => {
        const soldQty = productSalesLast7Days[produto.id] || 0;
        const dailySales = soldQty / 7; // Vendas diárias médias nos últimos 7 dias
        const projectedSalesNext7Days = dailySales * 7; // Projeção para os próximos 7 dias

        if (produto.estoque < projectedSalesNext7Days) {
          insufficientProdutos.push({
            ...produto,
            projectedSales: projectedSalesNext7Days,
            consumptionRate: dailySales,
          });
        }
      });

      return insufficientProdutos;
    };

    const insufficientProdutos = getProdutoStockAlerts();

    // Lógica para Títulos a Pagar em Aberto
    const getUnpaidSupplierBillsSummary = () => {
      const unpaidBills = contasAPagar.filter(conta => conta.status === 'Pendente');
      const totalUnpaidValue = unpaidBills.reduce((sum, conta) => sum + conta.valor, 0);
      const totalUnpaidCount = unpaidBills.length;
      return { totalUnpaidCount, totalUnpaidValue };
    };

    const { totalUnpaidCount, totalUnpaidValue } = getUnpaidSupplierBillsSummary();

    // Lógica para Total de Produção
    const getDailyProductionSummary = () => {
      let completedOrdersToday = 0;
      let pendingOrdersToday = 0;
      let totalKgProducedToday = 0;

      ordensProducao.forEach(order => {
        if (order.status === 'Concluído' && order.dataConclusao === todayISO) {
          completedOrdersToday++;
          totalKgProducedToday += order.quantidadeProduzida;
        } else if (order.status === 'Pendente' && order.data === todayISO) {
          pendingOrdersToday++;
        }
      });

      return {
        completedOrdersToday,
        pendingOrdersToday,
        totalKgProducedToday,
      };
    };

    const { completedOrdersToday, pendingOrdersToday, totalKgProducedToday } = getDailyProductionSummary();


    return (
      <div className="p-4 space-y-6">
        <h2 className="text-2xl font-bold text-green-800 mb-4">Visão Geral</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* Todos os cards agora são visíveis para o "admin" (papel padrão) */}
          <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
            <h3 className="text-lg font-semibold text-green-700 flex items-center mb-2"><Wheat size={20} className="mr-2"/> Total de Insumos</h3>
            <p className="text-3xl font-bold text-gray-800">{insumos.length}</p>
            <p className="text-sm text-gray-600">Estoque Total: {totalInsumosEstoque.toLocaleString('pt-BR')} kg</p>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
            <h3 className="text-lg font-semibold text-green-700 flex items-center mb-2"><Package size={20} className="mr-2"/> Total de Produtos</h3>
            <p className="text-3xl font-bold text-gray-800">{produtos.length}</p>
            <p className="text-sm text-gray-600">Estoque Total: {totalProdutosEstoque.toLocaleString('pt-BR')} kg</p>
          </div>
          <div
            className="bg-white p-6 rounded-xl shadow-md border border-green-200 cursor-pointer hover:bg-green-50 transition-colors duration-300"
            onClick={() => setCurrentPage('contasAPagarEmAberto')}
          >
            <h3 className="text-lg font-semibold text-green-700 flex items-center mb-2"><Truck size={20} className="mr-2"/> Total de Fornecedores</h3>
            <p className="text-3xl font-bold text-gray-800">{fornecedores.length}</p>
            <p className="text-sm text-gray-600">Títulos a Pagar em Aberto: <span className="font-bold text-red-600">{totalUnpaidCount}</span> (R$ {totalUnpaidValue.toFixed(2)})</p>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
            <h3 className="text-lg font-semibold text-green-700 flex items-center mb-2"><Users size={20} className="mr-2"/> Total de Clientes</h3>
            <p className="text-3xl font-bold text-gray-800">{clientes.length}</p>
            <p className="text-sm text-gray-600 flex items-center"><CheckCircle size={16} className="text-green-500 mr-1"/> Ativos: {activeClientsCount}</p>
            <p className="text-sm text-gray-600 flex items-center"><XCircle size={16} className="text-red-500 mr-1"/> Inativos (30+ dias): {inactiveClientsCount}</p>
          </div>
          <div
            className="bg-white p-6 rounded-xl shadow-md border border-red-300 cursor-pointer hover:bg-red-50 transition-colors duration-300"
            onClick={() => setCurrentPage('clientesEmAtraso')}
          >
            <h3 className="text-lg font-semibold text-red-700 flex items-center mb-2"><Clock size={20} className="mr-2"/> Clientes em Atraso</h3>
            <p className="text-3xl font-bold text-gray-800">{totalOverdueClients}</p>
            <p className="text-sm text-gray-600">Valor Total: R$ {totalOverdueValue.toFixed(2)}</p>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-md border border-blue-300">
            <h3 className="text-lg font-semibold text-blue-700 flex items-center mb-2"><Box size={20} className="mr-2"/> Total de Produção (Hoje)</h3>
            <p className="text-3xl font-bold text-gray-800">{totalKgProducedToday.toLocaleString('pt-BR')} kg</p>
            <p className="text-sm text-gray-600 flex items-center"><CheckCircle size={16} className="text-green-500 mr-1"/> Ordens Concluídas: {completedOrdersToday}</p>
            <p className="text-sm text-gray-600 flex items-center"><Clock size={16} className="text-yellow-500 mr-1"/> Ordens Pendentes: {pendingOrdersToday}</p>
          </div>
        </div>

        {/* Alerta de Estoque de Insumos */}
        <div className="bg-white p-6 rounded-xl shadow-md border border-yellow-300">
          <h3 className="text-lg font-semibold text-yellow-700 flex items-center mb-4"><AlertTriangle size={20} className="mr-2"/> Alerta de Estoque de Insumos (Próximos 7 dias)</h3>
          {insufficientInsumos.length === 0 ? (
            <p className="text-gray-500">Todos os insumos estão com estoque suficiente para os próximos 7 dias.</p>
          ) : (
            <ul className="list-disc list-inside text-gray-700">
              {insufficientInsumos.map(insumo => (
                <li key={insumo.id} className="text-red-600 font-medium">
                  {insumo.nome}: Estoque atual de {insumo.estoque.toLocaleString('pt-BR')} {insumo.unidade} é insuficiente para a demanda projetada de {insumo.projectedConsumption.toFixed(2).toLocaleString('pt-BR')} {insumo.unidade}.
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Alerta de Estoque de Produtos */}
        <div className="bg-white p-6 rounded-xl shadow-md border border-orange-300">
          <h3 className="text-lg font-semibold text-orange-700 flex items-center mb-4"><AlertTriangle size={20} className="mr-2"/> Alerta de Estoque de Produtos (Próximos 7 dias)</h3>
          {insufficientProdutos.length === 0 ? (
            <p className="text-gray-500">Todos os produtos estão com estoque suficiente para os próximos 7 dias.</p>
          ) : (
            <ul className="list-disc list-inside text-gray-700">
              {insufficientProdutos.map(produto => (
                <li key={produto.id} className="text-red-600 font-medium">
                  {produto.nome}: Estoque atual de {produto.estoque.toLocaleString('pt-BR')} {produto.unidade} é insuficiente para a venda projetada de {produto.projectedSales.toFixed(2).toLocaleString('pt-BR')} {produto.unidade}.
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Gráfico de Estoque de Insumos */}
        <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
          <h3 className="text-lg font-semibold text-green-700 flex items-center mb-4"><Wheat size={20} className="mr-2"/> Estoque de Insumos (Top 3)</h3>
          {topInsumos.length === 0 ? (
            <p className="text-gray-500">Nenhum insumo para exibir.</p>
          ) : (
            <div className="space-y-4">
              {topInsumos.map(item => (
                <div key={item.id} className="flex items-center">
                  <span className="w-24 text-sm font-medium text-gray-700 truncate mr-2">{item.nome}</span>
                  <div className="flex-1 bg-gray-200 rounded-full h-4">
                    <div
                      className="bg-green-500 h-4 rounded-full transition-all duration-500 ease-out"
                      style={{ width: `${(item.estoque / maxInsumoEstoque) * 100}%` }}
                      title={`${item.estoque} ${item.unidade}`}
                    ></div>
                  </div>
                  <span className="ml-2 text-sm text-gray-600">{item.estoque.toLocaleString('pt-BR')} {item.unidade}</span>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Gráfico de Estoque de Produtos */}
        <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
          <h3 className="text-lg font-semibold text-green-700 flex items-center mb-4"><Package size={20} className="mr-2"/> Estoque de Produtos (Top 3)</h3>
          <p className="text-3xl font-bold text-gray-800">{produtos.length}</p>
          {topProdutos.length === 0 ? (
            <p className="text-gray-500">Nenhum produto para exibir.</p>
          ) : (
            <div className="space-y-4">
              {topProdutos.map(item => (
                <div key={item.id} className="flex items-center">
                  <span className="w-24 text-sm font-medium text-gray-700 truncate mr-2">{item.nome}</span>
                  <div className="flex-1 bg-gray-200 rounded-full h-4">
                    <div
                      className="bg-purple-500 h-4 rounded-full transition-all duration-500 ease-out"
                      style={{ width: `${(item.estoque / maxProdutoEstoque) * 100}%` }}
                      title={`${item.estoque} ${item.unidade}`}
                    ></div>
                  </div>
                  <span className="ml-2 text-sm text-gray-600">{item.estoque.toLocaleString('pt-BR')} {item.unidade}</span>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Movimentações Recentes */}
        <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
          <h3 className="text-lg font-semibold text-green-700 flex items-center mb-2"><ArrowLeftRight size={20} className="mr-2"/> Movimentações Recentes</h3>
          {movimentacoes.length === 0 ? (
            <p className="text-gray-500">Nenhuma movimentação recente registada.</p>
          ) : (
            <ul className="list-disc list-inside text-gray-700">
              {movimentacoes.slice(-5).reverse().map(mov => {
                const fornecedorMov = fornecedores.find(f => f.id === mov.fornecedorId);
                return (
                  <li key={mov.id}>
                    {mov.data} - {mov.tipo === 'entrada' ? 'Entrada' : 'Saída'} de {mov.quantidade} {mov.unidade} de {mov.nomeItem} (Nota: {mov.numeroNota || 'N/A'}) {fornecedorMov ? ` - Fornecedor: ${fornecedorMov.nome}` : ''}
                  </li>
                );
              })}
            </ul>
          )}
        </div>
      </div>
    );
  };

  // Componente de Listagem Genérica com Busca
  const ItemList = ({ title, items, type, fields, onAdd, onEdit, onDelete, canAdd, canEdit, canDelete }) => {
    const [searchTerm, setSearchTerm] = useState('');

    const filteredItems = items.filter(item =>
      Object.values(item).some(value =>
        String(value).toLowerCase().includes(searchTerm.toLowerCase())
      )
    );

    return (
      <div className="p-4">
        <h2 className="text-2xl font-bold text-green-800 mb-4">{title}</h2>
        <div className="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-3 sm:space-y-0 sm:space-x-4">
          {canAdd && (
            <button
              onClick={onAdd}
              className="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center justify-center"
            >
              <Plus size={20} className="mr-2" /> Adicionar {title.slice(0, -1)}
            </button>
          )}
          <div className="relative w-full sm:w-1/2">
            <input
              type="text"
              placeholder={`Buscar em ${title}...`}
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
              aria-label={`Buscar em ${title}`}
            />
            <Search size={20} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-md overflow-hidden border border-green-200">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-green-100">
                <tr>
                  {fields.map(field => (
                    <th key={field.key} className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                      {field.label}
                    </th>
                  ))}
                  {(canEdit || canDelete) && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                  )}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {filteredItems.length === 0 ? (
                  <tr>
                    <td colSpan={fields.length + (canEdit || canDelete ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      Nenhum item encontrado.
                    </td>
                  </tr>
                ) : (
                  filteredItems.map(item => (
                    <tr key={item.id} className="hover:bg-gray-50">
                      {fields.map(field => (
                        <td key={field.key} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {item[field.key]}
                        </td>
                      ))}
                      {(canEdit || canDelete) && (
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <button
                            onClick={() => onEdit(item, type)}
                            className="text-blue-600 hover:text-blue-900 mr-3"
                            title="Editar"
                            aria-label={`Editar ${item.nome || item.id}`}
                          >
                            <Edit size={18} />
                          </button>
                          <button
                            onClick={() => onDelete(type, item)}
                            className="text-red-600 hover:text-red-900"
                            title="Excluir"
                            aria-label={`Excluir ${item.nome || item.id}`}
                          >
                            <Trash2 size={18} />
                          </button>
                        </td>
                      )}
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  };

  // Formulários Específicos para o Modal
  const InsumoForm = () => (
    <form onSubmit={handleSave} className="space-y-4">
      <div>
        <label htmlFor="nome" className="block text-sm font-medium text-gray-700">Nome do Insumo</label>
        <input
          type="text"
          id="nome"
          name="nome"
          defaultValue={editingItem?.nome || ''}
          placeholder="Ex: Milho"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="unidade" className="block text-sm font-medium text-gray-700">Unidade de Medida</label>
        <input
          type="text"
          id="unidade"
          name="unidade"
          defaultValue={editingItem?.unidade || ''}
          placeholder="Ex: kg, g, litro"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="estoque" className="block text-sm font-medium text-gray-700">Estoque (kg/un)</label>
        <input
          type="number"
          id="estoque"
          name="estoque"
          defaultValue={editingItem?.estoque || 0}
          placeholder="0"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="custo" className="block text-sm font-medium text-gray-700">Custo por Unidade (R$)</label>
        <input
          type="number"
          id="custo"
          name="custo"
          step="0.01"
          defaultValue={editingItem?.custo || 0}
          placeholder="0.00"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div className="flex justify-end space-x-3 mt-6">
        <button
          type="button"
          onClick={handleCancel}
          className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
        >
          <X size={18} className="mr-2" /> Cancelar
        </button>
        <button
          type="submit"
          className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
        >
          <Save size={18} className="mr-2" /> Salvar
        </button>
      </div>
    </form>
  );

  const ProdutoForm = () => (
    <form onSubmit={handleSave} className="space-y-4">
      <div>
        <label htmlFor="nome" className="block text-sm font-medium text-gray-700">Nome do Produto</label>
        <input
          type="text"
          id="nome"
          name="nome"
          defaultValue={editingItem?.nome || ''}
          placeholder="Ex: Ração Frango Inicial"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="unidade" className="block text-sm font-medium text-gray-700">Unidade de Venda</label>
        <input
          type="text"
          id="unidade"
          name="unidade"
          defaultValue={editingItem?.unidade || 'kg'}
          placeholder="Ex: kg, unidade"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="estoque" className="block text-sm font-medium text-gray-700">Estoque (kg)</label>
        <input
          type="number"
          id="estoque"
          name="estoque"
          defaultValue={editingItem?.estoque || 0}
          placeholder="0"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="preco" className="block text-sm font-medium text-gray-700">Preço de Venda (R$)</label>
        <input
          type="number"
          id="preco"
          name="preco"
          step="0.01"
          defaultValue={editingItem?.preco || 0}
          placeholder="0.00"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div className="flex justify-end space-x-3 mt-6">
        <button
          type="button"
          onClick={handleCancel}
          className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
        >
          <X size={18} className="mr-2" /> Cancelar
        </button>
        <button
          type="submit"
          className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
        >
          <Save size={18} className="mr-2" /> Salvar
        </button>
      </div>
    </form>
  );

  const FornecedorForm = () => (
    <form onSubmit={handleSave} className="space-y-4">
      <div>
        <label htmlFor="nome" className="block text-sm font-medium text-gray-700">Nome do Fornecedor</label>
        <input
          type="text"
          id="nome"
          name="nome"
          defaultValue={editingItem?.nome || ''}
          placeholder="Ex: AgroGrãos Ltda."
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="contato" className="block text-sm font-medium text-gray-700">Pessoa de Contato</label>
        <input
          type="text"
          id="contato"
          name="contato"
          defaultValue={editingItem?.contato || ''}
          placeholder="Ex: João Silva"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
        />
      </div>
      <div>
        <label htmlFor="telefone" className="block text-sm font-medium text-gray-700">Telefone</label>
        <input
          type="tel"
          id="telefone"
          name="telefone"
          defaultValue={editingItem?.telefone || ''}
          placeholder="Ex: (XX) XXXX-XXXX"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
        />
      </div>
      <div className="flex justify-end space-x-3 mt-6">
        <button
          type="button"
          onClick={handleCancel}
          className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
        >
          <X size={18} className="mr-2" /> Cancelar
        </button>
        <button
          type="submit"
          className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
        >
          <Save size={18} className="mr-2" /> Salvar
        </button>
      </div>
    </form>
  );

  const ClienteForm = () => (
    <form onSubmit={handleSave} className="space-y-4">
      <div>
        <label htmlFor="nome" className="block text-sm font-medium text-gray-700">Nome do Cliente</label>
        <input
          type="text"
          id="nome"
          name="nome"
          defaultValue={editingItem?.nome || ''}
          placeholder="Ex: Fazenda Boa Vista"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          required
        />
      </div>
      <div>
        <label htmlFor="contato" className="block text-sm font-medium text-gray-700">Pessoa de Contato</label>
        <input
          type="text"
          id="contato"
          name="contato"
          defaultValue={editingItem?.contato || ''}
          placeholder="Ex: Carlos Pereira"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
        />
      </div>
      <div>
        <label htmlFor="telefone" className="block text-sm font-medium text-gray-700">Telefone</label>
        <input
          type="tel"
          id="telefone"
          name="telefone"
          defaultValue={editingItem?.telefone || ''}
          placeholder="Ex: (XX) XXXX-XXXX"
          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
        />
      </div>
      <div className="flex justify-end space-x-3 mt-6">
        <button
          type="button"
          onClick={handleCancel}
          className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
        >
          <X size={18} className="mr-2" /> Cancelar
        </button>
        <button
          type="submit"
          className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
        >
          <Save size={18} className="mr-2" /> Salvar
        </button>
      </div>
    </form>
  );

  // Componente de Movimentação de Estoque
  const MovimentacaoEstoque = () => {
    const [itemType, setItemType] = useState('insumo');
    const [selectedInsumo, setSelectedInsumo] = useState('');
    const [quantidade, setQuantidade] = useState('');
    const [numeroNota, setNumeroNota] = useState('');
    const [selectedFornecedorMov, setSelectedFornecedorMov] = useState('');
    const [formaPagamentoMov, setFormaPagamentoMov] = useState('');
    const [prazoPagamentoMov, setPrazoPagamentoMov] = useState('');

    const handleMovimentacao = async (e) => {
      e.preventDefault();
      if (!selectedInsumo || !quantidade) {
        showAppMessage('Erro na Movimentação', 'Por favor, selecione um insumo e informe a quantidade.', 'error');
        return;
      }

      const insumoToUpdate = insumos.find(item => item.id === selectedInsumo);

      if (!insumoToUpdate) {
        showAppMessage('Erro na Movimentação', 'Insumo não encontrado.', 'error');
        return;
      }

      const newEstoque = insumoToUpdate.estoque + parseFloat(quantidade);

      const updatedInsumo = { ...insumoToUpdate, estoque: newEstoque };

      try {
        await updateItem('insumo', updatedInsumo);

        const newMovement = {
          data: new Date().toISOString().slice(0, 10),
          tipo: 'entrada',
          itemId: selectedInsumo,
          nomeItem: insumoToUpdate.nome,
          unidade: insumoToUpdate.unidade,
          quantidade: parseFloat(quantidade),
          numeroNota: numeroNota,
          fornecedorId: selectedFornecedorMov,
          formaPagamento: formaPagamentoMov,
          prazoPagamento: prazoPagamentoMov,
        };
        await addItem('movimentacao', newMovement);

        showAppMessage('Sucesso!', `Entrada de ${quantidade} ${insumoToUpdate.unidade} de ${insumoToUpdate.nome} registada com sucesso!`, 'success');
        setSelectedInsumo('');
        setQuantidade('');
        setNumeroNota('');
        setSelectedFornecedorMov('');
        setFormaPagamentoMov('');
        setPrazoPagamentoMov('');
      } catch (error) {
        showAppMessage('Erro na Movimentação', `Não foi possível registar a movimentação. Detalhes: ${error.message}`, 'error');
      }
    };

    return (
      <div className="p-4">
        <h2 className="text-2xl font-bold text-green-800 mb-4">Movimentação de Estoque - Entrada de Insumos</h2>

        <div className="bg-white p-6 rounded-xl shadow-md border border-green-200 mb-6">
          <form onSubmit={handleMovimentacao} className="space-y-4">
            <div>
              <label htmlFor="insumoSelect" className="block text-sm font-medium text-gray-700">Selecionar Insumo</label>
              <select
                id="insumoSelect"
                value={selectedInsumo}
                onChange={(e) => setSelectedInsumo(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
                required
              >
                <option value="">Selecione...</option>
                {insumos.map(item => (
                  <option key={item.id} value={item.id}>{item.nome} (Estoque: {item.estoque} {item.unidade})</option>
                ))}
              </select>
            </div>

            <div>
              <label htmlFor="quantidade" className="block text-sm font-medium text-gray-700">Quantidade</label>
              <input
                type="number"
                id="quantidade"
                value={quantidade}
                onChange={(e) => setQuantidade(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
                required
                min="0.01"
                step="0.01"
                placeholder="0.00"
              />
            </div>

            <div>
              <label htmlFor="numeroNota" className="block text-sm font-medium text-gray-700">Número da Nota</label>
              <input
                type="text"
                id="numeroNota"
                value={numeroNota}
                onChange={(e) => setNumeroNota(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
                placeholder="Ex: NF-12345"
              />
            </div>

            <div>
              <label htmlFor="fornecedorMov" className="block text-sm font-medium text-gray-700">Fornecedor</label>
              <select
                id="fornecedorMov"
                value={selectedFornecedorMov}
                onChange={(e) => setSelectedFornecedorMov(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
              >
                <option value="">Selecione um Fornecedor</option>
                {fornecedores.map(forn => (
                  <option key={forn.id} value={forn.id}>{forn.nome}</option>
                ))}
              </select>
            </div>

            <div>
              <label htmlFor="formaPagamentoMov" className="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
              <select
                id="formaPagamentoMov"
                value={formaPagamentoMov}
                onChange={(e) => setFormaPagamentoMov(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
              >
                <option value="">Selecione a Forma</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cartao de Credito">Cartão de Crédito</option>
                <option value="Pix">Pix</option>
                <option value="Boleto">Boleto</option>
                <option value="Transferencia Bancaria">Transferência Bancária</option>
                <option value="Outros">Outros</option>
              </select>
            </div>

            <div>
              <label htmlFor="prazoPagamentoMov" className="block text-sm font-medium text-gray-700">Prazo de Pagamento</label>
              <input
                type="text"
                id="prazoPagamentoMov"
                value={prazoPagamentoMov}
                onChange={(e) => setPrazoPagamentoMov(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
                placeholder="Ex: À vista, 30 dias"
              />
            </div>

            <button
              type="submit"
              className="w-full bg-green-700 text-white px-4 py-3 rounded-lg shadow-md hover:bg-green-800 transition-colors duration-300 flex items-center justify-center font-semibold text-lg"
            >
              <Save size={20} className="mr-2" /> Registar Entrada
            </button>
          </form>
        </div>
      </div>
    );
  };

  // Componente de Página de Produção
  const PaginaProducao = () => {
    const [selectedProdutoParaFormula, setSelectedProdutoParaFormula] = useState('');
    const [formulaIngredientes, setFormulaIngredientes] = useState([]);

    const handleAddIngrediente = () => {
      setFormulaIngredientes([...formulaIngredientes, { insumoId: '', quantidadeNecessaria: '', unidade: '' }]);
    };

    const handleRemoveIngrediente = (indexToRemove) => {
      setFormulaIngredientes(formulaIngredientes.filter((_, index) => index !== indexToRemove));
    };

    const handleIngredienteChange = (index, field, value) => {
      const newIngredientes = [...formulaIngredientes];
      newIngredientes[index][field] = value;
      if (field === 'insumoId') {
        const selectedInsumo = insumos.find(i => i.id === value);
        if (selectedInsumo) {
          newIngredientes[index].unidade = selectedInsumo.unidade;
        }
      }
      setFormulaIngredientes(newIngredientes);
    };

    const handleCreateFormula = () => {
      setEditingItem(null);
      setFormType('formula');
      setSelectedProdutoParaFormula('');
      setFormulaIngredientes([]);
    };

    const handleEditFormula = (formula) => {
      setEditingItem(formula);
      setFormType('formula');
      setSelectedProdutoParaFormula(formula.produtoId);
      setFormulaIngredientes(formula.ingredientes);
    };

    const handleCreateOrdemProducao = () => {
      setEditingItem(null);
      setFormType('ordemProducao');
    };

    const handleRequestConcluirProducao = (order) => {
      setOrderToConfirm(order);
      setConfirmModalMessage(`Deseja realmente concluir a ordem de produção "${order.id}"? Isso irá baixar o estoque de insumos e adicionar ao estoque do produto final.`);
      setConfirmModalAction(() => () => confirmProductionCompletion(order));
      setShowConfirmModal(true);
    };

    const confirmProductionCompletion = async (order) => {
      const formula = formulas.find(f => f.id === order.formulaId);
      if (!formula) {
        showAppMessage('Erro de Produção', 'Fórmula não encontrada para esta ordem de produção.', 'error');
        setShowConfirmModal(false);
        return;
      }

      let canProduce = true;
      const insumosToUpdate = [];

      for (const ingrediente of formula.ingredientes) {
        const insumo = insumos.find(i => i.id === ingrediente.insumoId);
        if (!insumo) {
          showAppMessage('Erro de Produção', `Insumo "${ingrediente.insumoId}" não encontrado.`, 'error');
          canProduce = false;
          break;
        }
        const quantidadeTotalNecessaria = ingrediente.quantidadePorUnidadeProduto * order.quantidadeProduzida;
        if (insumo.estoque < quantidadeTotalNecessaria) {
          showAppMessage('Estoque Insuficiente', `Estoque insuficiente de ${insumo.nome}. Necessário: ${quantidadeTotalNecessaria} ${insumo.unidade}, Disponível: ${insumo.estoque} ${insumo.unidade}.`, 'error');
          canProduce = false;
          break;
        }
        insumosToUpdate.push({ ...insumo, estoque: insumo.estoque - quantidadeTotalNecessaria });
      }

      if (!canProduce) {
        setShowConfirmModal(false);
        return;
      }

      try {
        for (const insumo of insumosToUpdate) {
          await updateItem('insumo', insumo);
        }

        const produtoFinal = produtos.find(p => p.id === formula.produtoId);
        if (produtoFinal) {
          await updateItem('produto', { ...produtoFinal, estoque: produtoFinal.estoque + order.quantidadeProduzida });
        } else {
          showAppMessage('Atenção', `Produto final "${formula.produtoId}" não encontrado. Estoque do produto não atualizado.`, 'info');
        }

        await updateItem('ordemProducao', { ...order, status: 'Concluído', dataConclusao: new Date().toISOString().slice(0, 10) });

        showAppMessage('Produção Concluída!', `Ordem de produção ${order.id} concluída com sucesso. Estoque atualizado.`, 'success');
      } catch (error) {
        console.error("Erro ao concluir produção no Firestore:", error);
        showAppMessage('Erro ao Concluir Produção', `Não foi possível concluir a produção. Detalhes: ${error.message}`, 'error');
      } finally {
        setShowConfirmModal(false);
      }
    };

    const canManageFormulas = userRole === 'admin';
    const canManageOrders = userRole === 'admin' || userRole === 'producao';

    return (
      <div className="p-4 space-y-6">
        <h2 className="text-2xl font-bold text-green-800 mb-4">Módulo de Produção</h2>

        <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
          <h3 className="text-xl font-semibold text-green-700 mb-4 flex items-center"><Factory size={20} className="mr-2"/> Fórmulas de Ração</h3>
          {canManageFormulas && (
            <button
              onClick={handleCreateFormula}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 flex items-center mb-4"
            >
              <Plus size={20} className="mr-2" /> Nova Fórmula
            </button>
          )}
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-blue-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nome da Fórmula</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Produto Final</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ingredientes</th>
                  {(canManageFormulas) && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                  )}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {formulas.length === 0 ? (
                  <tr>
                    <td colSpan={3 + (canManageFormulas ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      Nenhuma fórmula cadastrada.
                    </td>
                  </tr>
                ) : (
                  formulas.map(formula => {
                    const produtoAssociado = produtos.find(p => p.id === formula.produtoId);
                    return (
                      <tr key={formula.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formula.nome}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{produtoAssociado ? produtoAssociado.nome : 'Produto Não Encontrado'}</td>
                        <td className="px-6 py-4 text-sm text-gray-900">
                          <ul className="list-disc list-inside">
                            {formula.ingredientes.map((ing, idx) => {
                              const insumoAssociado = insumos.find(i => i.id === ing.insumoId);
                              return (
                                <li key={idx}>
                                  {insumoAssociado ? insumoAssociado.nome : 'Insumo Não Encontrado'}: {ing.quantidadePorUnidadeProduto} {ing.unidade}
                                </li>
                              );
                            })}
                          </ul>
                        </td>
                        {canManageFormulas && (
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button
                              onClick={() => handleEditFormula(formula)}
                              className="text-blue-600 hover:text-blue-900 mr-3"
                              title="Editar Fórmula"
                            >
                              <Edit size={18} />
                            </button>
                            <button
                              onClick={() => handleDeleteRequest('formula', formula)}
                              className="text-red-600 hover:text-red-900"
                              title="Excluir Fórmula"
                            >
                              <Trash2 size={18} />
                            </button>
                          </td>
                        )}
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
          <h3 className="text-xl font-semibold text-green-700 mb-4 flex items-center"><Factory size={20} className="mr-2"/> Ordens de Produção</h3>
          {canManageOrders && (
            <button
              onClick={handleCreateOrdemProducao}
              className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center mb-4"
            >
              <Plus size={20} className="mr-2" /> Nova Ordem de Produção
            </button>
          )}
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-green-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ID Ordem</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Fórmula</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Qtd. Produzida (kg)</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                  {(canManageOrders) && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                  )}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {ordensProducao.length === 0 ? (
                  <tr>
                    <td colSpan={5 + (canManageOrders ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      Nenhuma ordem de produção.
                    </td>
                  </tr>
                ) : (
                  ordensProducao.map(order => {
                    const formulaAssociada = formulas.find(f => f.id === order.formulaId);
                    return (
                      <tr key={order.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{order.id}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{order.data}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formulaAssociada ? formulaAssociada.nome : 'Fórmula Não Encontrada'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{order.quantidadeProduzida}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            order.status === 'Concluído' ? 'bg-green-100 text-green-800' :
                            order.status === 'Pendente' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                          }`}>
                            {order.status}
                          </span>
                        </td>
                        {canManageOrders && (
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            {order.status !== 'Concluído' && (
                              <button
                                onClick={() => handleRequestConcluirProducao(order)}
                                className="text-green-600 hover:text-green-900 mr-3"
                                title="Concluir Produção"
                              >
                                <Save size={18} />
                              </button>
                            )}
                            <button
                              onClick={() => handleDeleteRequest('ordemProducao', order)}
                              className="text-red-600 hover:text-red-900"
                              title="Excluir Ordem de Produção"
                            >
                              <Trash2 size={18} />
                            </button>
                          </td>
                        )}
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  };

  // Função auxiliar para calcular a data de vencimento com base no prazo de pagamento
  const calculateDueDate = (startDateString, paymentTerm) => {
    const startDate = new Date(startDateString + 'T00:00:00');
    if (paymentTerm.toLowerCase().includes('à vista')) {
      return startDateString;
    } else if (paymentTerm.toLowerCase().includes('dias')) {
      const days = parseInt(paymentTerm.match(/\d+/)[0], 10);
      if (!isNaN(days)) {
        startDate.setDate(startDate.getDate() + days);
        return startDate.toISOString().slice(0, 10);
      }
    }
    return startDateString;
  };

  // Componente de Página de Pedidos do Cliente
  const PaginaPedidos = () => {
    const handleCreatePedido = () => {
      setEditingItem(null);
      setFormType('pedido');
    };

    const handleRequestConcluirPedido = (pedido) => {
      setPedidoToConfirm(pedido);
      setConfirmModalMessage(`Deseja realmente concluir o pedido "${pedido.id}" do cliente "${clientes.find(c => c.id === pedido.clienteId)?.nome || 'N/A'}"? Isso irá baixar o estoque dos produtos e gerar uma Conta a Receber.`);
      setConfirmModalAction(() => () => confirmPedidoCompletion(pedido));
      setShowConfirmModal(true);
    };

    const confirmPedidoCompletion = async (pedido) => {
      let canFulfill = true;
      const produtosToUpdate = [];

      for (const item of pedido.itens) {
        const produto = produtos.find(p => p.id === item.produtoId);
        if (!produto) {
          showAppMessage('Erro no Pedido', `Produto "${item.produtoId}" não encontrado no estoque.`, 'error');
          canFulfill = false;
          break;
        }
        if (produto.estoque < item.quantidade) {
          showAppMessage('Estoque Insuficiente', `Estoque insuficiente de ${produto.nome}. Necessário: ${item.quantidade} kg, Disponível: ${produto.estoque} kg.`, 'error');
          canFulfill = false;
          break;
        }
        produtosToUpdate.push({ ...produto, estoque: produto.estoque - item.quantidade });
      }

      if (!canFulfill) {
        setShowConfirmModal(false);
        return;
      }

      try {
        for (const produto of produtosToUpdate) {
          await updateItem('produto', produto);
        }

        await updateItem('pedido', { ...pedido, status: 'Concluído', dataConclusao: new Date().toISOString().slice(0, 10) });

        const dueDate = calculateDueDate(pedido.dataPedido, pedido.prazoPagamento);
        const newContaReceber = {
          descricao: `Recebimento de Pedido ${pedido.id}`,
          valor: pedido.valorTotal,
          dataVencimento: dueDate,
          clienteId: pedido.clienteId,
          status: 'Pendente',
          dataRecebimento: '',
        };
        await addItem('contaReceber', newContaReceber);


        showAppMessage('Pedido Concluído!', `Pedido ${pedido.id} concluído com sucesso. Estoque de produtos atualizado e Conta a Receber gerada.`, 'success');
      } catch (error) {
        console.error("Erro ao concluir pedido no Firestore:", error);
        showAppMessage('Erro ao Concluir Pedido', `Não foi possível concluir o pedido. Detalhes: ${error.message}`, 'error');
      } finally {
        setShowConfirmModal(false);
      }
    };

    const canManagePedidos = userRole === 'admin' || userRole === 'vendas';

    return (
      <div className="p-4 space-y-6">
        <h2 className="text-2xl font-bold text-green-800 mb-4">Pedidos do Cliente</h2>

        <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
          <h3 className="text-xl font-semibold text-green-700 mb-4 flex items-center"><ShoppingCart size={20} className="mr-2"/> Lista de Pedidos</h3>
          {canManagePedidos && (
            <button
              onClick={handleCreatePedido}
              className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center mb-4"
            >
              <Plus size={20} className="mr-2" /> Novo Pedido
            </button>
          )}
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-green-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ID Pedido</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cliente</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Itens</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Valor Total (R$)</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Forma Pagamento</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Prazo Pagamento</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                  {(canManagePedidos) && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                  )}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {pedidos.length === 0 ? (
                  <tr>
                    <td colSpan={8 + (canManagePedidos ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      Nenhum pedido cadastrado.
                    </td>
                  </tr>
                ) : (
                  pedidos.map(pedido => {
                    const clienteAssociado = clientes.find(c => c.id === pedido.clienteId);
                    return (
                      <tr key={pedido.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{pedido.id}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{clienteAssociado ? clienteAssociado.nome : 'Cliente Não Encontrado'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{pedido.dataPedido}</td>
                        <td className="px-6 py-4 text-sm text-gray-900">
                          <ul className="list-disc list-inside">
                            {pedido.itens.map((item, idx) => {
                              const produtoAssociado = produtos.find(p => p.id === item.produtoId);
                              return (
                                <li key={idx}>
                                  {produtoAssociado ? produtoAssociado.nome : 'Produto Não Encontrado'}: {item.quantidade} kg @ R$ {item.precoUnitario.toFixed(2)}
                                </li>
                              );
                            })}
                          </ul>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ {pedido.valorTotal.toFixed(2)}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{pedido.formaPagamento || 'N/A'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{pedido.prazoPagamento || 'N/A'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            pedido.status === 'Concluído' ? 'bg-green-100 text-green-800' :
                            pedido.status === 'Pendente' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                          }`}>
                            {pedido.status}
                          </span>
                        </td>
                        {canManagePedidos && (
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            {pedido.status !== 'Concluído' && (
                              <button
                                onClick={() => handleRequestConcluirPedido(pedido)}
                                className="text-green-600 hover:text-green-900 mr-3"
                                title="Concluir Pedido"
                              >
                                <Save size={18} />
                              </button>
                            )}
                            <button
                              onClick={() => handleDeleteRequest('pedido', pedido)}
                              className="text-red-600 hover:text-red-900"
                              title="Excluir Pedido"
                            >
                              <Trash2 size={18} />
                            </button>
                          </td>
                        )}
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  };

  // Componente de Página Financeiro (Contas a Pagar e Receber)
  const PaginaFinanceiro = () => {
    const [financeiroTab, setFinanceiroTab] = useState('pagar');
    const [filterPagar, setFilterPagar] = useState('all');
    const [filterReceber, setFilterReceber] = useState('all');

    const handleMarkAsPaidOrReceived = async (conta, type) => {
      const updatedConta = { ...conta, status: (type === 'contaPagar' ? 'Pago' : 'Recebido'), dataPagamento: new Date().toISOString().slice(0, 10), dataRecebimento: new Date().toISOString().slice(0, 10) };
      try {
        await updateItem(type, updatedConta);
        showAppMessage('Sucesso!', `Conta ${type === 'contaPagar' ? 'paga' : 'recebida'} com sucesso!`, 'success');
      } catch (error) {
        showAppMessage('Erro!', `Não foi possível atualizar o status da conta. Detalhes: ${error.message}`, 'error');
      } finally {
        setShowConfirmModal(false);
      }
    };

    const handleRequestMarkAsPaidOrReceived = (conta, type) => {
      setContaToConfirm(conta);
      setContaTypeToConfirm(type);
      setConfirmModalMessage(`Tem certeza que deseja marcar esta conta como ${type === 'contaPagar' ? 'Paga' : 'Recebida'}?`);
      setConfirmModalAction(() => () => handleMarkAsPaidOrReceived(conta, type));
      setShowConfirmModal(true);
    };

    const getFilteredContas = (list, filterType) => {
      let filtered = list;

      if (filterType === 'pendente') {
        filtered = filtered.filter(conta => conta.status === 'Pendente' && !isOverdue(conta.dataVencimento, conta.status));
      } else if (filterType === 'pago') {
        filtered = filtered.filter(conta => conta.status === 'Pago');
      } else if (filterType === 'recebido') {
        filtered = filtered.filter(conta => conta.status === 'Recebido');
      } else if (filterType === 'atrasado') {
        filtered = filtered.filter(conta => isOverdue(conta.dataVencimento, conta.status));
      }

      return filtered.sort((a, b) => {
        const aOverdue = isOverdue(a.dataVencimento, a.status);
        const bOverdue = isOverdue(b.dataVencimento, b.status);

        if (aOverdue && !bOverdue) return -1;
        if (!aOverdue && bOverdue) return 1;

        return new Date(a.dataVencimento) - new Date(b.dataVencimento);
      });
    };

    const filteredContasAPagar = getFilteredContas(contasAPagar, filterPagar);
    const filteredContasAReceber = getFilteredContas(contasAReceber, filterReceber);

    const canManageFinanceiro = userRole === 'admin' || userRole === 'financeiro';

    return (
      <div className="p-4 space-y-6">
        <h2 className="text-2xl font-bold text-green-800 mb-4">Módulo Financeiro</h2>

        <div className="flex justify-center space-x-4 mb-6">
          <button
            onClick={() => setFinanceiroTab('pagar')}
            className={`px-6 py-2 rounded-lg font-semibold transition-colors duration-300 ${financeiroTab === 'pagar' ? 'bg-red-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
          >
            Contas a Pagar
          </button>
          <button
            onClick={() => setFinanceiroTab('receber')}
            className={`px-6 py-2 rounded-lg font-semibold transition-colors duration-300 ${financeiroTab === 'receber' ? 'bg-green-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
          >
            Contas a Receber
          </button>
        </div>

        {financeiroTab === 'pagar' && (
          <div className="bg-white p-6 rounded-xl shadow-md border border-red-200">
            <h3 className="text-xl font-semibold text-red-700 mb-4 flex items-center"><DollarSign size={20} className="mr-2"/> Contas a Pagar</h3>
            {canManageFinanceiro && (
              <button
                onClick={() => handleEdit(null, 'contaPagar')}
                className="bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-300 flex items-center mb-4"
              >
                <Plus size={20} className="mr-2" /> Adicionar Conta a Pagar
              </button>
            )}
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-red-100">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Descrição</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Valor (R$)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Vencimento</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Fornecedor</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Pgto.</th>
                    {(canManageFinanceiro) && (
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                    )}
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredContasAPagar.length === 0 ? (
                    <tr>
                      <td colSpan={6 + (canManageFinanceiro ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        Nenhuma conta a pagar encontrada com este filtro.
                      </td>
                    </tr>
                  ) : (
                    filteredContasAPagar.map(conta => {
                      const fornecedorAssociado = fornecedores.find(f => f.id === conta.fornecedorId);
                      const isOverdueAccount = isOverdue(conta.dataVencimento, conta.status);
                      return (
                        <tr key={conta.id} className={`hover:bg-gray-50 ${isOverdueAccount ? 'bg-red-50' : ''}`}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.descricao}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ {conta.valor.toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.dataVencimento}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{fornecedorAssociado ? fornecedorAssociado.nome : 'N/A'}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              conta.status === 'Pago' ? 'bg-green-100 text-green-800' :
                              isOverdueAccount ? 'bg-red-200 text-red-800' :
                              'bg-yellow-100 text-yellow-800'
                            }`}>
                              {isOverdueAccount ? 'Em Atraso' : conta.status}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.dataPagamento || 'Pendente'}</td>
                          {canManageFinanceiro && (
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                              {conta.status !== 'Pago' && (
                                <button
                                  onClick={() => handleRequestMarkAsPaidOrReceived(conta, 'contaPagar')}
                                  className="text-green-600 hover:text-green-900 mr-3"
                                  title="Marcar como Pago"
                                >
                                  <Save size={18} />
                                </button>
                              )}
                              <button
                                onClick={() => handleEdit(conta, 'contaPagar')}
                                className="text-blue-600 hover:text-blue-900 mr-3"
                                title="Editar"
                              >
                                <Edit size={18} />
                              </button>
                              <button
                                onClick={() => handleDeleteRequest('contaPagar', conta)}
                                className="text-red-600 hover:text-red-900"
                                title="Excluir"
                              >
                                <Trash2 size={18} />
                              </button>
                            </td>
                          )}
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {financeiroTab === 'receber' && (
          <div className="bg-white p-6 rounded-xl shadow-md border border-green-200">
            <h3 className="text-xl font-semibold text-green-700 mb-4 flex items-center"><DollarSign size={20} className="mr-2"/> Contas a Receber</h3>
            <div className="flex flex-wrap gap-2 mb-4">
              <button
                onClick={() => setFilterReceber('all')}
                className={`px-4 py-2 rounded-lg text-sm font-medium ${filterReceber === 'all' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
              >
                Todas
              </button>
              <button
                onClick={() => setFilterReceber('pendente')}
                className={`px-4 py-2 rounded-lg text-sm font-medium ${filterReceber === 'pendente' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
              >
                Pendentes
              </button>
              <button
                onClick={() => setFilterReceber('recebido')}
                className={`px-4 py-2 rounded-lg text-sm font-medium ${filterReceber === 'recebido' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
              >
                Recebidas
              </button>
              <button
                onClick={() => setFilterReceber('atrasado')}
                className={`px-4 py-2 rounded-lg text-sm font-medium ${filterReceber === 'atrasado' ? 'bg-red-700 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
              >
                Em Atraso
              </button>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-green-100">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Descrição</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Valor (R$)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Vencimento</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cliente</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Recbto.</th>
                    {(canManageFinanceiro) && (
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                    )}
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredContasAReceber.length === 0 ? (
                    <tr>
                      <td colSpan={6 + (canManageFinanceiro ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        Nenhuma conta a receber encontrada com este filtro.
                      </td>
                    </tr>
                  ) : (
                    filteredContasAReceber.map(conta => {
                      const clienteAssociado = clientes.find(c => c.id === conta.clienteId);
                      const isOverdueAccount = isOverdue(conta.dataVencimento, conta.status);
                      return (
                        <tr key={conta.id} className={`hover:bg-gray-50 ${isOverdueAccount ? 'bg-red-50' : ''}`}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.descricao}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ {conta.valor.toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.dataVencimento}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{clienteAssociado ? clienteAssociado.nome : 'N/A'}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              conta.status === 'Recebido' ? 'bg-green-100 text-green-800' :
                              isOverdueAccount ? 'bg-red-200 text-red-800' :
                              'bg-yellow-100 text-yellow-800'
                            }`}>
                              {isOverdueAccount ? 'Em Atraso' : conta.status}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.dataRecebimento || 'Pendente'}</td>
                          {canManageFinanceiro && (
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                              {conta.status !== 'Recebido' && (
                                <button
                                  onClick={() => handleRequestMarkAsPaidOrReceived(conta, 'contaReceber')}
                                  className="text-green-600 hover:text-green-900 mr-3"
                                  title="Marcar como Recebido"
                                >
                                  <Save size={18} />
                                </button>
                              )}
                              <button
                                onClick={() => handleEdit(conta, 'contaReceber')}
                                className="text-blue-600 hover:text-blue-900 mr-3"
                                title="Editar"
                              >
                                <Edit size={18} />
                              </button>
                              <button
                                onClick={() => handleDeleteRequest('contaReceber', conta)}
                                className="text-red-600 hover:text-red-900"
                                title="Excluir"
                              >
                                <Trash2 size={18} />
                              </button>
                            </td>
                          )}
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Novo Componente: Página de Clientes em Atraso
  const PaginaClientesEmAtraso = () => {
    const overdueReceivables = contasAReceber.filter(conta => isOverdue(conta.dataVencimento, conta.status));

    const clientsWithOverdue = {};
    overdueReceivables.forEach(conta => {
      if (!clientsWithOverdue[conta.clienteId]) {
        clientsWithOverdue[conta.clienteId] = {
          client: clientes.find(c => c.id === conta.clienteId),
          totalOverdue: 0,
          accounts: [],
        };
      }
      clientsWithOverdue[conta.clienteId].totalOverdue += conta.valor;
      clientsWithOverdue[conta.clienteId].accounts.push(conta);
    });

    const overdueClientList = Object.values(clientsWithOverdue);

    return (
      <div className="p-4">
        <h2 className="text-2xl font-bold text-red-800 mb-4 flex items-center">
          <Clock size={24} className="mr-2" /> Clientes com Contas em Atraso
        </h2>
        <button
          onClick={() => setCurrentPage('dashboard')}
          className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center mb-4"
        >
          <ArrowLeftRight size={18} className="mr-2" /> Voltar para o Dashboard
        </button>

        <div className="bg-white rounded-xl shadow-md overflow-hidden border border-red-200">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-red-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cliente</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Telefone</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Total em Atraso (R$)</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Contas em Atraso</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {overdueClientList.length === 0 ? (
                  <tr>
                    <td colSpan={4} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      Nenhum cliente com contas em atraso.
                    </td>
                  </tr>
                ) : (
                  overdueClientList.map(clientData => (
                    <tr key={clientData.client?.id || 'unknown'} className="hover:bg-red-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {clientData.client?.nome || 'Cliente Desconhecido'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {clientData.client?.telefone || 'N/A'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-red-700 font-bold">
                        R$ {clientData.totalOverdue.toFixed(2)}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        <ul className="list-disc list-inside">
                          {clientData.accounts.map(account => (
                            <li key={account.id}>
                              {account.descricao} (Vencimento: {account.dataVencimento}, R$ {account.valor.toFixed(2)})
                            </li>
                          ))}
                        </ul>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  };

  // Novo Componente: Página de Contas a Pagar em Aberto
  const PaginaContasAPagarEmAberto = () => {
    const pendingBills = contasAPagar.filter(conta => conta.status === 'Pendente');

    return (
      <div className="p-4">
        <h2 className="text-2xl font-bold text-red-800 mb-4 flex items-center">
          <DollarSign size={24} className="mr-2" /> Contas a Pagar em Aberto
        </h2>
        <button
          onClick={() => setCurrentPage('dashboard')}
          className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center mb-4"
        >
          <ArrowLeftRight size={18} className="mr-2" /> Voltar para o Dashboard
        </button>

        <div className="bg-white rounded-xl shadow-md overflow-hidden border border-red-200">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-red-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Descrição</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Valor (R$)</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Vencimento</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Fornecedor</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {pendingBills.length === 0 ? (
                  <tr>
                    <td colSpan={6} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      Nenhuma conta a pagar em aberto.
                    </td>
                  </tr>
                ) : (
                  pendingBills.map(conta => {
                    const fornecedorAssociado = fornecedores.find(f => f.id === conta.fornecedorId);
                    const isOverdueAccount = isOverdue(conta.dataVencimento, conta.status);
                    return (
                      <tr key={conta.id} className={`hover:bg-gray-50 ${isOverdueAccount ? 'bg-red-50' : ''}`}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.descricao}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ {conta.valor.toFixed(2)}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.dataVencimento}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{fornecedorAssociado ? fornecedorAssociado.nome : 'N/A'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            conta.status === 'Pago' ? 'bg-green-100 text-green-800' :
                            isOverdueAccount ? 'bg-red-200 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                          }`}>
                            {isOverdueAccount ? 'Em Atraso' : conta.status}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{conta.dataPagamento || 'Pendente'}</td>
                        {canManageFinanceiro && (
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            {conta.status !== 'Pago' && (
                              <button
                                onClick={() => handleRequestMarkAsPaidOrReceived(conta, 'contaPagar')}
                                className="text-green-600 hover:text-green-900 mr-3"
                                title="Marcar como Pago"
                              >
                                <Save size={18} />
                              </button>
                            )}
                            <button
                              onClick={() => handleEdit(conta, 'contaPagar')}
                              className="text-blue-600 hover:text-blue-900 mr-3"
                              title="Editar"
                            >
                              <Edit size={18} />
                            </button>
                            <button
                              onClick={() => handleDeleteRequest('contaPagar', conta)}
                              className="text-red-600 hover:text-red-900"
                              title="Excluir"
                              >
                              <Trash2 size={18} />
                            </button>
                          </td>
                        )}
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  };

  // Formulário para Fórmulas
  const FormulaForm = () => {
    const [selectedProduto, setSelectedProduto] = useState(editingItem?.produtoId || '');
    const [currentIngredientes, setCurrentIngredientes] = useState(editingItem?.ingredientes || [{ insumoId: '', quantidadeNecessaria: '', unidade: '' }]);

    useEffect(() => {
      if (editingItem) {
        setSelectedProduto(editingItem.produtoId);
        setCurrentIngredientes(editingItem.ingredientes);
      } else {
        setSelectedProduto('');
        setCurrentIngredientes([{ insumoId: '', quantidadeNecessaria: '', unidade: '' }]);
      }
    }, [editingItem]);

    const handleAddIngrediente = () => {
      setCurrentIngredientes([...currentIngredientes, { insumoId: '', quantidadeNecessaria: '', unidade: '' }]);
    };

    const handleRemoveIngrediente = (indexToRemove) => {
      setCurrentIngredientes(currentIngredientes.filter((_, index) => index !== indexToRemove));
    };

    const handleIngredienteChange = (index, field, value) => {
      const newIngredientes = [...currentIngredientes];
      newIngredientes[index][field] = value;
      if (field === 'insumoId') {
        const selectedInsumo = insumos.find(i => i.id === value);
        if (selectedInsumo) {
          newIngredientes[index].unidade = selectedInsumo.unidade;
        } else {
          newIngredientes[index].unidade = '';
        }
      }
      setCurrentIngredientes(newIngredientes);
    };

    const handleSubmitFormula = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newFormula = {
        nome: formData.get('nome'),
        produtoId: selectedProduto,
        ingredientes: currentIngredientes.map(ing => ({
          insumoId: ing.insumoId,
          quantidadeNecessaria: parseFloat(ing.quantidadeNecessaria),
          unidade: ing.unidade,
        })),
      };

      if (editingItem && editingItem.id) {
        updateItem('formula', { ...editingItem, ...newFormula });
      } else {
        addItem('formula', newFormula);
      }
      handleCancel();
    };

    return (
      <form onSubmit={handleSubmitFormula} className="space-y-4">
        <div>
          <label htmlFor="nome" className="block text-sm font-medium text-gray-700">Nome da Fórmula</label>
          <input
            type="text"
            id="nome"
            name="nome"
            defaultValue={editingItem?.nome || ''}
            placeholder="Ex: Ração Frango Inicial - Agroceres"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          />
        </div>
        <div>
          <label htmlFor="produtoId" className="block text-sm font-medium text-gray-700">Produto Final</label>
          <select
            id="produtoId"
            name="produtoId"
            value={selectedProduto}
            onChange={(e) => setSelectedProduto(e.target.value)}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          >
            <option value="">Selecione um Produto</option>
            {produtos.map(prod => (
              <option key={prod.id} value={prod.id}>{prod.nome}</option>
            ))}
          </select>
        </div>

        <h4 className="text-md font-semibold text-gray-700 mt-6 mb-2">Ingredientes:</h4>
        {currentIngredientes.map((ing, index) => (
          <div key={index} className="flex flex-col sm:flex-row gap-2 items-end border p-3 rounded-md bg-gray-50">
            <div className="flex-1 w-full">
              <label htmlFor={`ingredienteId-${index}`} className="block text-xs font-medium text-gray-600">Insumo</label>
              <select
                id={`ingredienteId-${index}`}
                name="ingredienteId"
                value={ing.insumoId}
                onChange={(e) => handleIngredienteChange(index, 'insumoId', e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                required
              >
                <option value="">Selecione um Insumo</option>
                {insumos.map(insumo => (
                  <option key={insumo.id} value={insumo.id}>{insumo.nome}</option>
                ))}
              </select>
            </div>
            <div className="w-full sm:w-1/3">
              <label htmlFor={`quantidadeNecessaria-${index}`} className="block text-xs font-medium text-gray-600">Qtd. Necessária</label>
              <input
                type="number"
                id={`quantidadeNecessaria-${index}`}
                name="quantidadeNecessaria"
                value={ing.quantidadeNecessaria}
                onChange={(e) => handleIngredienteChange(index, 'quantidadeNecessaria', e.target.value)}
                step="0.001"
                placeholder="0.000"
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                required
              />
            </div>
            <div className="w-full sm:w-1/4">
              <label htmlFor={`ingredienteUnidade-${index}`} className="block text-xs font-medium text-gray-600">Unidade</label>
              <input
                type="text"
                id={`ingredienteUnidade-${index}`}
                name="ingredienteUnidade"
                value={ing.unidade}
                onChange={(e) => handleIngredienteChange(index, 'unidade', e.target.value)}
                placeholder="Unidade"
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                required
              />
            </div>
            <button
              type="button"
              onClick={() => handleRemoveIngrediente(index)}
              className="p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200"
              title="Remover Ingrediente"
            >
              <Trash2 size={18} />
            </button>
          </div>
        ))}
        <button
          type="button"
          onClick={handleAddIngrediente}
          className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-300 transition-colors duration-300 flex items-center mt-4"
        >
          <Plus size={18} className="mr-2" /> Adicionar Ingrediente
        </button>

        <div className="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            onClick={handleCancel}
            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
          >
            <X size={18} className="mr-2" /> Cancelar
          </button>
          <button
            type="submit"
            className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
          >
            <Save size={18} className="mr-2" /> Salvar Fórmula
          </button>
        </div>
      </form>
    );
  };

  // Formulário para Ordem de Produção
  const OrdemProducaoForm = () => {
    const [selectedProduto, setSelectedProduto] = useState('');
    const [formulasDisponiveis, setFormulasDisponiveis] = useState([]);
    const [selectedFormula, setSelectedFormula] = useState('');

    useEffect(() => {
      if (selectedProduto) {
        const filteredFormulas = formulas.filter(f => f.produtoId === selectedProduto);
        setFormulasDisponiveis(filteredFormulas);
        setSelectedFormula(filteredFormulas.length > 0 ? filteredFormulas[0].id : '');
      } else {
        setFormulasDisponiveis([]);
        setSelectedFormula('');
      }
    }, [selectedProduto, formulas]);

    const handleSubmitOrdemProducao = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const quantidade = parseFloat(formData.get('quantidadeProduzida'));

      if (!selectedFormula || !quantidade) {
        showAppMessage('Erro', 'Por favor, preencha todos os campos.', 'error');
        return;
      }

      const newOrder = {
        data: new Date().toISOString().slice(0, 10),
        formulaId: selectedFormula,
        quantidadeProduzida: quantidade,
        status: 'Pendente',
      };

      addItem('ordemProducao', newOrder);
      showAppMessage('Sucesso!', 'Ordem de produção criada com sucesso!', 'success');
      handleCancel();
    };

    return (
      <form onSubmit={handleSubmitOrdemProducao} className="space-y-4">
        <div>
          <label htmlFor="produtoSelect" className="block text-sm font-medium text-gray-700">Produto a ser Produzido</label>
          <select
            id="produtoSelect"
            value={selectedProduto}
            onChange={(e) => setSelectedProduto(e.target.value)}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          >
            <option value="">Selecione um Produto</option>
            {produtos.map(prod => (
              <option key={prod.id} value={prod.id}>{prod.nome}</option>
            ))}
          </select>
        </div>

        <div>
          <label htmlFor="formulaSelect" className="block text-sm font-medium text-gray-700">Fórmula de Ração</label>
          <select
            id="formulaSelect"
            value={selectedFormula}
            onChange={(e) => setSelectedFormula(e.target.value)}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
            disabled={formulasDisponiveis.length === 0}
          >
            <option value="">Selecione uma Fórmula</option>
            {formulasDisponiveis.map(formula => (
              <option key={formula.id} value={formula.id}>{formula.nome}</option>
            ))}
          </select>
          {selectedProduto && formulasDisponiveis.length === 0 && (
            <p className="text-sm text-red-500 mt-1">Não há fórmulas cadastradas para este produto.</p>
          )}
        </div>

        <div>
          <label htmlFor="quantidadeProduzida" className="block text-sm font-medium text-gray-700">Quantidade a Produzir (kg)</label>
          <input
            type="number"
            id="quantidadeProduzida"
            name="quantidadeProduzida"
            step="0.01"
            placeholder="0.00"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
            min="0.01"
          />
        </div>

        <div className="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            onClick={handleCancel}
            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
          >
            <X size={18} className="mr-2" /> Cancelar
          </button>
          <button
            type="submit"
            className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
          >
            <Save size={18} className="mr-2" /> Criar Ordem
          </button>
        </div>
      </form>
    );
  };

  // Formulário para Pedidos do Cliente
  const PedidoForm = () => {
    const [selectedCliente, setSelectedCliente] = useState(editingItem?.clienteId || '');
    const [currentItens, setCurrentItens] = useState(editingItem?.itens || [{ produtoId: '', quantidade: '', precoUnitario: '' }]);
    const [totalPedido, setTotalPedido] = useState(editingItem?.valorTotal || 0);
    const [formaPagamento, setFormaPagamento] = useState(editingItem?.formaPagamento || '');
    const [prazoPagamento, setPrazoPagamento] = useState(editingItem?.prazoPagamento || '');

    useEffect(() => {
      calculateTotal();
    }, [currentItens]);

    const calculateTotal = () => {
      const total = currentItens.reduce((sum, item) => {
        const qty = parseFloat(item.quantidade) || 0;
        const price = parseFloat(item.precoUnitario) || 0;
        return sum + (qty * price);
      }, 0);
      setTotalPedido(total);
    };

    const handleAddProdutoItem = () => {
      setCurrentItens([...currentItens, { produtoId: '', quantidade: '', precoUnitario: '' }]);
    };

    const handleRemoveProdutoItem = (indexToRemove) => {
      setCurrentItens(currentItens.filter((_, index) => index !== indexToRemove));
    };

    const handleProdutoItemChange = (index, field, value) => {
      const newItens = [...currentItens];
      newItens[index][field] = value;

      if (field === 'produtoId') {
        const selectedProduto = produtos.find(p => p.id === value);
        if (selectedProduto) {
          newItens[index].precoUnitario = selectedProduto.preco;
        } else {
          newItens[index].precoUnitario = '';
        }
      }
      setCurrentItens(newItens);
    };

    const handleSubmitPedido = (e) => {
      e.preventDefault();
      if (!selectedCliente || currentItens.length === 0 || currentItens.some(item => !item.produtoId || !item.quantidade || !item.precoUnitario)) {
        showAppMessage('Erro', 'Por favor, preencha todos os campos do pedido e adicione pelo menos um item válido.', 'error');
        return;
      }

      const newPedido = {
        clienteId: selectedCliente,
        dataPedido: new Date().toISOString().slice(0, 10),
        itens: currentItens.map(item => ({
          produtoId: item.produtoId,
          quantidade: parseFloat(item.quantidade),
          precoUnitario: parseFloat(item.precoUnitario),
        })),
        valorTotal: totalPedido,
        status: 'Pendente',
        formaPagamento: formaPagamento,
        prazoPagamento: prazoPagamento,
      };

      if (editingItem && editingItem.id) {
        updateItem('pedido', { ...editingItem, ...newPedido });
      } else {
        addItem('pedido', newPedido);
      }
      handleCancel();
    };

    return (
      <form onSubmit={handleSubmitPedido} className="space-y-4">
        <div>
          <label htmlFor="clienteSelect" className="block text-sm font-medium text-gray-700">Cliente</label>
          <select
            id="clienteSelect"
            name="clienteId"
            value={selectedCliente}
            onChange={(e) => setSelectedCliente(e.target.value)}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          >
            <option value="">Selecione um Cliente</option>
            {clientes.map(cliente => (
              <option key={cliente.id} value={cliente.id}>{cliente.nome}</option>
            ))}
          </select>
        </div>

        <div>
          <label htmlFor="formaPagamento" className="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
          <select
            id="formaPagamento"
            name="formaPagamento"
            value={formaPagamento}
            onChange={(e) => setFormaPagamento(e.target.value)}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          >
            <option value="">Selecione a Forma</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="Cartao de Credito">Cartão de Crédito</option>
            <option value="Pix">Pix</option>
            <option value="Boleto">Boleto</option>
            <option value="Transferencia Bancaria">Transferência Bancária</option>
            <option value="Outros">Outros</option>
          </select>
        </div>

        <div>
          <label htmlFor="prazoPagamento" className="block text-sm font-medium text-gray-700">Prazo de Pagamento</label>
          <input
            type="text"
            id="prazoPagamento"
            name="prazoPagamento"
            value={prazoPagamento}
            onChange={(e) => setPrazoPagamento(e.target.value)}
            placeholder="Ex: À vista, 30 dias, 15/30/45 dias"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          />
        </div>

        <h4 className="text-md font-semibold text-gray-700 mt-6 mb-2">Itens do Pedido:</h4>
        {currentItens.map((item, index) => (
          <div key={index} className="flex flex-col sm:flex-row gap-2 items-end border p-3 rounded-md bg-gray-50">
            <div className="flex-1 w-full">
              <label htmlFor={`produtoId-${index}`} className="block text-xs font-medium text-gray-600">Produto</label>
              <select
                id={`produtoId-${index}`}
                name="produtoId"
                value={item.produtoId}
                onChange={(e) => handleProdutoItemChange(index, 'produtoId', e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                required
              >
                <option value="">Selecione um Produto</option>
                {produtos.map(produto => (
                  <option key={produto.id} value={produto.id}>{produto.nome}</option>
                ))}
              </select>
            </div>
            <div className="w-full sm:w-1/4">
              <label htmlFor={`quantidade-${index}`} className="block text-xs font-medium text-gray-600">Qtd (kg)</label>
              <input
                type="number"
                id={`quantidade-${index}`}
                name="quantidade"
                value={item.quantidade}
                onChange={(e) => handleProdutoItemChange(index, 'quantidade', e.target.value)}
                step="0.01"
                placeholder="0.00"
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                required
              />
            </div>
            <div className="w-full sm:w-1/4">
              <label htmlFor={`precoUnitario-${index}`} className="block text-xs font-medium text-gray-600">Preço Unit. (R$)</label>
              <input
                type="number"
                id={`precoUnitario-${index}`}
                name="precoUnitario"
                value={item.precoUnitario}
                onChange={(e) => handleProdutoItemChange(index, 'precoUnitario', e.target.value)}
                step="0.01"
                placeholder="0.00"
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                required
              />
            </div>
            <button
              type="button"
              onClick={() => handleRemoveProdutoItem(index)}
              className="p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200"
              title="Remover Item"
            >
              <Trash2 size={18} />
            </button>
          </div>
        ))}
        <button
          type="button"
          onClick={handleAddProdutoItem}
          className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-300 transition-colors duration-300 flex items-center mt-4"
        >
          <Plus size={18} className="mr-2" /> Adicionar Item
        </button>

        <div className="text-right text-lg font-bold text-green-800 mt-4">
          Valor Total do Pedido: R$ {totalPedido.toFixed(2)}
        </div>

        <div className="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            onClick={handleCancel}
            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
          >
            <X size={18} className="mr-2" /> Cancelar
          </button>
          <button
            type="submit"
            className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
          >
            <Save size={18} className="mr-2" /> Salvar Pedido
          </button>
        </div>
      </form>
    );
  };

  // Formulário para Contas a Pagar
  const ContaPagarForm = () => {
    const [selectedFornecedor, setSelectedFornecedor] = useState(editingItem?.fornecedorId || '');

    const handleSubmitContaPagar = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newConta = {
        descricao: formData.get('descricao'),
        valor: parseFloat(formData.get('valor')),
        dataVencimento: formData.get('dataVencimento'),
        fornecedorId: selectedFornecedor,
        status: editingItem?.status || 'Pendente',
        dataPagamento: editingItem?.dataPagamento || '',
      };

      if (editingItem && editingItem.id) {
        updateItem('contaPagar', { ...editingItem, ...newConta });
      } else {
        addItem('contaPagar', newConta);
      }
      handleCancel();
    };

    return (
      <form onSubmit={handleSubmitContaPagar} className="space-y-4">
        <div>
          <label htmlFor="descricao" className="block text-sm font-medium text-gray-700">Descrição</label>
          <input
            type="text"
            id="descricao"
            name="descricao"
            defaultValue={editingItem?.descricao || ''}
            placeholder="Ex: Aluguel do galpão"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-red-500 focus:border-red-500"
            required
          />
        </div>
        <div>
          <label htmlFor="valor" className="block text-sm font-medium text-gray-700">Valor (R$)</label>
          <input
            type="number"
            id="valor"
            name="valor"
            step="0.01"
            defaultValue={editingItem?.valor || 0}
            placeholder="0.00"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-red-500 focus:border-red-500"
            required
          />
        </div>
        <div>
          <label htmlFor="dataVencimento" className="block text-sm font-medium text-gray-700">Data de Vencimento</label>
          <input
            type="date"
            id="dataVencimento"
            name="dataVencimento"
            defaultValue={editingItem?.dataVencimento || ''}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-red-500 focus:border-red-500"
            required
          />
        </div>
        <div>
          <label htmlFor="fornecedorSelect" className="block text-sm font-medium text-gray-700">Fornecedor (Opcional)</label>
          <select
            id="fornecedorSelect"
            name="fornecedorId"
            value={selectedFornecedor}
            onChange={(e) => setSelectedFornecedor(e.target.value)}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-red-500 focus:border-red-500"
          >
            <option value="">Nenhum</option>
            {fornecedores.map(forn => (
              <option key={forn.id} value={forn.id}>{forn.nome}</option>
            ))}
          </select>
        </div>

        <div className="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            onClick={handleCancel}
            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
        >
            <X size={18} className="mr-2" /> Cancelar
          </button>
          <button
            type="submit"
            className="bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-300 flex items-center"
          >
            <Save size={18} className="mr-2" /> Salvar Conta
          </button>
        </div>
      </form>
    );
  };

  // Formulário para Contas a Receber
  const ContaReceberForm = () => {
    const [selectedCliente, setSelectedCliente] = useState(editingItem?.clienteId || '');

    const handleSubmitContaReceber = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newConta = {
        descricao: formData.get('descricao'),
        valor: parseFloat(formData.get('valor')),
        dataVencimento: formData.get('dataVencimento'),
        clienteId: selectedCliente,
        status: editingItem?.status || 'Pendente',
        dataRecebimento: editingItem?.dataRecebimento || '',
      };

      if (editingItem && editingItem.id) {
        updateItem('contaReceber', { ...editingItem, ...newConta });
      } else {
        addItem('contaReceber', newConta);
      }
      handleCancel();
    };

    return (
      <form onSubmit={handleSubmitContaReceber} className="space-y-4">
        <div>
          <label htmlFor="descricao" className="block text-sm font-medium text-gray-700">Descrição</label>
          <input
            type="text"
            id="descricao"
            name="descricao"
            defaultValue={editingItem?.descricao || ''}
            placeholder="Ex: Venda de ração para Fazenda X"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          />
        </div>
        <div>
          <label htmlFor="valor" className="block text-sm font-medium text-gray-700">Valor (R$)</label>
          <input
            type="number"
            id="valor"
            name="valor"
            step="0.01"
            defaultValue={editingItem?.valor || 0}
            placeholder="0.00"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          />
        </div>
        <div>
          <label htmlFor="dataVencimento" className="block text-sm font-medium text-gray-700">Data de Vencimento</label>
          <input
            type="date"
            id="dataVencimento"
            name="dataVencimento"
            defaultValue={editingItem?.dataVencimento || ''}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
            required
          />
        </div>
        <div>
          <label htmlFor="clienteSelect" className="block text-sm font-medium text-gray-700">Cliente (Opcional)</label>
          <select
            id="clienteSelect"
            name="clienteId"
            value={selectedCliente}
            onChange={(e) => setSelectedCliente(e.target.value)}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
          >
            <option value="">Nenhum</option>
            {clientes.map(cli => (
              <option key={cli.id} value={cli.id}>{cli.nome}</option>
            ))}
          </select>
        </div>

        <div className="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            onClick={handleCancel}
            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
          >
            <X size={18} className="mr-2" /> Cancelar
          </button>
          <button
            type="submit"
            className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
          >
            <Save size={18} className="mr-2" /> Salvar Conta
          </button>
        </div>
      </form>
    );
  };

  // Novo Componente: Formulário para Alterar Senha (utilizador logado)
  const ChangePasswordForm = ({ currentUser, showAppMessage, onClose }) => {
    const [currentPassword, setCurrentPassword] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmNewPassword, setConfirmNewPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const [showCurrentPassword, setShowCurrentPassword] = useState(false);
    const [showNewPassword, setShowNewPassword] = useState(false);
    const [showConfirmNewPassword, setShowConfirmNewPassword] = useState(false);

    const handleChangePassword = async (e) => {
      e.preventDefault();
      setError('');
      setLoading(true);

      if (newPassword !== confirmNewPassword) {
        setError('A nova senha e a confirmação não coincidem.');
        setLoading(false);
        return;
      }

      if (newPassword.length < 6) {
        setError('A nova senha deve ter pelo menos 6 caracteres.');
        setLoading(false);
        return;
      }

      try {
        // Re-autentica o utilizador antes de alterar a senha
        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
        await reauthenticateWithCredential(currentUser, credential);

        await updatePassword(currentUser, newPassword);
        showAppMessage('Sucesso!', 'Sua senha foi alterada com sucesso!', 'success');
        onClose();
      } catch (err) {
        console.error("Erro ao alterar senha:", err);
        let errorMessage = 'Erro ao alterar senha. Verifique sua senha atual.';
        if (err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
          errorMessage = 'A senha atual está incorreta.';
        } else if (err.code === 'auth/weak-password') {
          errorMessage = 'A nova senha é muito fraca. Escolha uma mais forte.';
        } else if (err.code === 'auth/requires-recent-login') {
          errorMessage = 'Por favor, faça login novamente para alterar sua senha (sessão expirada).';
          // Opcional: forçar logout aqui para que o utilizador faça login novamente
          // signOut(auth);
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    return (
      <FormModal title="Alterar Senha" onClose={onClose}>
        <form onSubmit={handleChangePassword} className="space-y-4">
          <div>
            <label htmlFor="currentPassword" className="block text-sm font-medium text-gray-700">Senha Atual</label>
            <div className="relative">
              <input
                type={showCurrentPassword ? 'text' : 'password'}
                id="currentPassword"
                value={currentPassword}
                onChange={(e) => setCurrentPassword(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-green-500 focus:border-green-500"
                required
              />
              <button
                type="button"
                onClick={() => setShowCurrentPassword(!showCurrentPassword)}
                className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
              >
                {showCurrentPassword ? <EyeOff size={20} /> : <Eye size={20} />}
              </button>
            </div>
          </div>
          <div>
            <label htmlFor="newPassword" className="block text-sm font-medium text-gray-700">Nova Senha</label>
            <div className="relative">
              <input
                type={showNewPassword ? 'text' : 'password'}
                id="newPassword"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-green-500 focus:border-green-500"
                required
              />
              <button
                type="button"
                onClick={() => setShowNewPassword(!showNewPassword)}
                className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
              >
                {showNewPassword ? <EyeOff size={20} /> : <Eye size={20} />}
              </button>
            </div>
          </div>
          <div>
            <label htmlFor="confirmNewPassword" className="block text-sm font-medium text-gray-700">Confirmar Nova Senha</label>
            <div className="relative">
              <input
                type={showConfirmNewPassword ? 'text' : 'password'}
                id="confirmNewPassword"
                value={confirmNewPassword}
                onChange={(e) => setConfirmNewPassword(e.target.value)}
                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-green-500 focus:border-green-500"
                required
              />
              <button
                type="button"
                onClick={() => setShowConfirmNewPassword(!showConfirmNewPassword)}
                className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
              >
                {showConfirmNewPassword ? <EyeOff size={20} /> : <Eye size={20} />}
              </button>
            </div>
          </div>
          {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
            >
              <X size={18} className="mr-2" /> Cancelar
            </button>
            <button
              type="submit"
              className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
              disabled={loading}
            >
              {loading && <Loader2 className="animate-spin mr-2" size={18} />}
              <Save size={18} className="mr-2" /> Alterar Senha
            </button>
          </div>
        </form>
      </FormModal>
    );
  };

  // Novo Componente: Formulário para Esqueci a Senha
  const ForgotPasswordForm = ({ auth, showAppMessage, onClose }) => {
    const [email, setEmail] = useState('');
    const [message, setMessage] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleResetPassword = async (e) => {
      e.preventDefault();
      setMessage('');
      setError('');
      setLoading(true);

      try {
        await sendPasswordResetEmail(auth, email);
        setMessage('Um link para redefinir sua senha foi enviado para o seu e-mail.');
        setEmail('');
      } catch (err) {
        console.error("Erro ao redefinir senha:", err);
        let errorMessage = 'Erro ao enviar o e-mail de redefinição de senha.';
        if (err.code === 'auth/user-not-found') {
          errorMessage = 'Nenhum utilizador encontrado com este e-mail.';
        } else if (err.code === 'auth/invalid-email') {
          errorMessage = 'Endereço de e-mail inválido.';
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    return (
      <FormModal title="Esqueci a Senha" onClose={onClose}>
        <form onSubmit={handleResetPassword} className="space-y-4">
          <div>
            <label htmlFor="resetEmail" className="block text-sm font-medium text-gray-700">E-mail</label>
            <input
              type="email"
              id="resetEmail"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"
              placeholder="seu.email@exemplo.com"
              required
            />
          </div>
          {message && <p className="text-green-600 text-sm mt-2">{message}</p>}
          {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
          <div className="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              onClick={onClose}
              className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-300 flex items-center"
            >
              <X size={18} className="mr-2" /> Cancelar
            </button>
            <button
              type="submit"
              className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 flex items-center"
              disabled={loading}
            >
              {loading && <Loader2 className="animate-spin mr-2" size={18} />}
              Enviar Link
            </button>
          </div>
        </form>
      </FormModal>
    );
  };


  // Componente da Página de Login/Registo
  const LoginPage = ({ onLoginSuccess }) => {
    const [isRegistering, setIsRegistering] = useState(false);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [name, setName] = useState('');
    const [role, setRole] = useState('producao'); // Papel padrão para novos utilizadores
    const [error, setError] = useState(''); // Mensagem de erro geral
    const [emailError, setEmailError] = useState(''); // Erro de e-mail específico
    const [passwordError, setPasswordError] = useState(''); // Erro de senha específico
    const [loading, setLoading] = useState(false);
    const [showPassword, setShowPassword] = useState(false); // Estado para visibilidade da senha

    // Limpa os erros quando o modo de registo/login é alternado
    useEffect(() => {
      setError('');
      setEmailError('');
      setPasswordError('');
    }, [isRegistering]);

    const handleAuthAction = async (e) => {
      e.preventDefault();
      setError(''); // Limpa o erro ao tentar uma nova ação
      setEmailError('');
      setPasswordError('');
      setLoading(true);

      // Verifica se Firebase Auth e Firestore estão inicializados
      if (!auth || !db) {
        setError('Serviços Firebase não inicializados. Tente recarregar a página.');
        setLoading(false);
        return;
      }

      try {
        if (isRegistering) {
          if (password !== confirmPassword) {
            setPasswordError('As senhas não coincidem.');
            setLoading(false);
            return;
          }
          console.log("Tentando registar novo utilizador:", email); // Log de depuração

          // Lógica para o primeiro utilizador ser admin
          const userProfilesCollectionRef = collection(db, `artifacts/${appId}/userProfiles`);
          const adminQuery = query(userProfilesCollectionRef, where("role", "==", "admin"));
          const adminSnap = await getDocs(adminQuery);

          let assignedRole = role; // Assume o papel selecionado pelo utilizador ou padrão
          if (adminSnap.empty) {
            // Se não houver nenhum admin, o primeiro utilizador se torna admin
            assignedRole = 'admin';
            console.log("Primeiro utilizador a registar. Atribuindo perfil: admin");
          } else {
            console.log("Já existe um admin. Atribuindo perfil padrão:", assignedRole);
          }

          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          console.log("createUserWithEmailAndPassword bem-sucedido. UID:", userCredential.user.uid); // Log de sucesso
          const user = userCredential.user;

          // Envia e-mail de verificação
          await sendEmailVerification(user);
          console.log("Email de verificação enviado para:", user.email);

          // Cria o perfil do utilizador no Firestore com o papel atribuído
          await setDoc(doc(db, `artifacts/${appId}/userProfiles`, user.uid), {
            email: user.email,
            name: name,
            role: assignedRole,
          });

          showAppMessage('Sucesso!', 'Conta criada com sucesso! Por favor, verifique seu e-mail para ativar sua conta e fazer login.', 'success');
          // Força o logout após o registo para que o utilizador precise verificar o e-mail
          await signOut(auth);
          setIsRegistering(false); // Volta para a tela de login
        } else {
          console.log("Tentando fazer login com:", email); // Log de depuração
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          console.log("signInWithEmailAndPassword bem-sucedido. UID:", user.uid, "Email Verificado:", user.emailVerified); // Log de sucesso

          // Verifica se o e-mail foi verificado após o login
          if (!user.emailVerified) {
            await signOut(auth); // Desloga o utilizador se o e-mail não for verificado
            showAppMessage('Verificação de E-mail Necessária', 'Seu e-mail não foi verificado. Por favor, verifique sua caixa de entrada. Você pode reenviar o e-mail de verificação se necessário.', 'info');
            setLoading(false);
            return;
          }

          showAppMessage('Sucesso!', 'Login realizado com sucesso!', 'success');
          console.log("onLoginSuccess chamado após o login."); // Log
          onLoginSuccess(); // Notifica o componente pai para mudar de página
        }
      } catch (err) {
        console.error("Erro de autenticação:", err);
        console.error("Código de Erro do Firebase Auth:", err.code);
        let errorMessage = 'Ocorreu um erro. Tente novamente.';

        switch (err.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'Este e-mail já está cadastrado. Por favor, faça login.';
            setEmailError(errorMessage);
            setIsRegistering(false); // Encaminha para tela de login
            break;
          case 'auth/invalid-email':
            errorMessage = 'Endereço de e-mail inválido.';
            setEmailError(errorMessage);
            break;
          case 'auth/weak-password':
            errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
            setPasswordError(errorMessage);
            break;
          case 'auth/user-not-found':
          case 'auth/wrong-password':
          case 'auth/invalid-credential':
            errorMessage = 'E-mail ou senha inválidos.';
            setEmailError(errorMessage);
            setPasswordError(errorMessage);
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Falha na conexão de rede. Verifique sua internet.';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'A operação de e-mail/senha não está ativada no Firebase. Por favor, ative-a no console do Firebase.';
            break;
          case 'auth/api-key-not-valid': // Adicionado tratamento específico para a chave API inválida
            errorMessage = 'Chave da API do Firebase inválida. Por favor, verifique sua configuração no console do Firebase.';
            setError(errorMessage);
            break;
          default:
            // Mensagem de erro geral se não houver tratamento específico
            setError(errorMessage);
            break;
        }
      } finally {
        setLoading(false);
      }
    };

    const handleResendVerificationEmail = async () => {
      if (!email) {
        showAppMessage('Erro', 'Por favor, insira seu e-mail para reenviar o link de verificação.', 'error');
        return;
      }
      setLoading(true);
      try {
        // Para reenviar, precisamos de um utilizador existente (mesmo que não verificado)
        // Uma forma de fazer isso é tentar logar silenciosamente ou apenas usar sendPasswordResetEmail
        // O Firebase Auth não tem um `resendEmailVerification` sem um `currentUser` ativo.
        // A melhor abordagem é instruir o utilizador a tentar fazer login novamente, o que acionará o check de verificação.
        // Ou, se o utilizador estiver na tela de registo, ele já terá recebido.
        // Para esta tela de login, se ele *não* estiver logado e precisar reenviar,
        // a única forma é ele tentar logar (e ser deslogado por não verificado) ou usar o "Esqueci a Senha"
        // para um fluxo de redefinição que também pode ajudar a confirmar o e-mail.
        // Para simplificar, vou adicionar uma mensagem informativa.
        showAppMessage('Reenviar Verificação', 'Se você já se registrou e não recebeu o e-mail, tente fazer login novamente ou use a opção "Esqueci a Senha" para um novo fluxo de verificação.', 'info');
      } catch (err) {
        console.error("Erro ao reenviar e-mail de verificação:", err);
        showAppMessage('Erro ao Reenviar', `Não foi possível reenviar o e-mail. Detalhes: ${err.message}`, 'error');
      } finally {
        setLoading(false);
      }
    };


    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-500 to-lime-600 p-4">
        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md animate-fade-in-up">
          <h2 className="text-3xl font-bold text-center text-green-800 mb-6">
            {isRegistering ? 'Criar Nova Conta' : 'Login'}
          </h2>
          <form onSubmit={handleAuthAction} className="space-y-5">
            {isRegistering && (
              <div>
                <label htmlFor="name" className="block text-sm font-medium text-gray-700">Nome Completo</label>
                <input
                  type="text"
                  id="name"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500"
                  placeholder="Seu Nome"
                  required={isRegistering}
                />
              </div>
            )}
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700">E-mail</label>
              <input
                type="email"
                id="email"
                value={email}
                onChange={(e) => { setEmail(e.target.value); setEmailError(''); }} // Limpa erro ao digitar
                className={`mt-1 block w-full border ${emailError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500`}
                placeholder="seu.email@exemplo.com"
                required
              />
              {emailError && <p className="text-red-500 text-xs mt-1">{emailError}</p>}
            </div>
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700">Senha</label>
              <div className="relative">
                <input
                  type={showPassword ? 'text' : 'password'}
                  id="password"
                  value={password}
                  onChange={(e) => { setPassword(e.target.value); setPasswordError(''); }} // Limpa erro ao digitar
                  className={`mt-1 block w-full border ${passwordError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm p-3 pr-10 focus:ring-green-500 focus:border-green-500`}
                  placeholder="••••••••"
                  required
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                  aria-label={showPassword ? 'Ocultar senha' : 'Mostrar senha'}
                >
                  {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                </button>
              </div>
              {passwordError && <p className="text-red-500 text-xs mt-1">{passwordError}</p>}
            </div>
            {isRegistering && (
              <>
                <div>
                  <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700">Confirmar Senha</label>
                  <div className="relative">
                    <input
                      type={showPassword ? 'text' : 'password'}
                      id="confirmPassword"
                      value={confirmPassword}
                      onChange={(e) => { setConfirmPassword(e.target.value); setPasswordError(''); }} // Limpa erro ao digitar
                      className={`mt-1 block w-full border ${passwordError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm p-3 pr-10 focus:ring-green-500 focus:border-green-500`}
                      placeholder="••••••••"
                      required
                    />
                    <button
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                      aria-label={showPassword ? 'Ocultar senha' : 'Mostrar senha'}
                    >
                      {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                    </button>
                  </div>
                  {passwordError && <p className="text-red-500 text-xs mt-1">{passwordError}</p>}
                </div>
                <div>
                  <label htmlFor="role" className="block text-sm font-medium text-gray-700">Tipo de Perfil</label>
                  <select
                    id="role"
                    value={role}
                    onChange={(e) => setRole(e.target.value)}
                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500"
                    required
                  >
                    <option value="producao">Produção</option>
                    <option value="vendas">Vendas</option>
                    <option value="financeiro">Financeiro</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
              </>
            )}

            {error && ( // Exibição da mensagem de erro geral
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative" role="alert">
                <span className="block sm:inline">{error}</span>
              </div>
            )}

            <button
              type="submit"
              className="w-full bg-green-700 text-white py-3 rounded-lg shadow-lg hover:bg-green-800 transition-colors duration-300 flex items-center justify-center font-semibold text-lg"
              disabled={loading}
            >
              {loading && <Loader2 className="animate-spin mr-2" size={20} />}
              {isRegistering ? 'Registar' : 'Entrar'}
            </button>
          </form>

          <div className="mt-6 text-center space-y-2">
            <button
              onClick={() => setIsRegistering(!isRegistering)}
              className="text-green-700 hover:underline text-sm block w-full"
            >
              {isRegistering ? 'Já tem uma conta? Faça login' : 'Não tem uma conta? Registe-se'}
            </button>
            {!isRegistering && (
              <button
                onClick={() => setShowForgotPasswordModal(true)}
                className="text-blue-600 hover:underline text-sm block w-full"
              >
                Esqueceu a senha?
              </button>
            )}
            {!isRegistering && (
              <button
                onClick={handleResendVerificationEmail}
                className="text-purple-600 hover:underline text-sm block w-full"
                disabled={loading}
              >
                {loading ? 'Reenviando...' : 'Reenviar E-mail de Verificação (se já registou)'}
              </button>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Componente de Gerenciamento de Utilizadores (Apenas para Admin)
  const GerenciarUsuarios = () => {
    const [editingUser, setEditingUser] = useState(null);
    const [newRole, setNewRole] = useState('');
    const [showUserConfirmModal, setShowUserConfirmModal] = useState(false);
    const [userToActOn, setUserToActOn] = useState(null);
    const [userActionType, setUserActionType] = useState(''); // 'delete' ou 'updateRole'

    const handleEditUserRole = (user) => {
      setEditingUser(user);
      setNewRole(user.role);
    };

    const handleSaveUserRole = async () => {
      if (!editingUser || !newRole) return;
      try {
        const userProfileRef = doc(db, `artifacts/${appId}/userProfiles`, editingUser.id);
        await updateDoc(userProfileRef, { role: newRole });
        showAppMessage('Sucesso!', `Perfil de ${editingUser.email} atualizado para ${newRole}.`, 'success');
        setEditingUser(null);
      } catch (error) {
        console.error("Erro ao atualizar perfil do utilizador:", error);
        showAppMessage('Erro ao Atualizar Perfil', `Não foi possível atualizar o perfil. Detalhes: ${error.message}`, 'error');
      }
    };

    const handleDeleteUserRequest = (user) => {
      setUserToActOn(user);
      setUserActionType('delete');
      setConfirmModalMessage(`Tem certeza que deseja excluir o utilizador "${user.email}"? Esta ação é irreversível e removerá o perfil e todos os dados associados a ele.`);
      setConfirmModalAction(() => confirmDeleteUser);
      setShowUserConfirmModal(true);
    };

    const confirmDeleteUser = async () => {
      if (!userToActOn) return;
      try {
        // Excluir o perfil do Firestore
        const userProfileRef = doc(db, `artifacts/${appId}/userProfiles`, userToActOn.id);
        await deleteDoc(userProfileRef);

        // ATENÇÃO: Excluir o utilizador do Authentication é uma operação de ADMIN SDK (servidor).
        // Não é possível fazer isso diretamente do cliente por segurança.
        // Se você precisa excluir o utilizador do Auth, precisaria de uma Firebase Function ou um backend.
        // Por enquanto, apenas o perfil no Firestore será removido.
        showAppMessage('Utilizador Excluído (Perfil)', `O perfil de ${userToActOn.email} foi removido do Firestore.`, 'success');

        // Opcional: Se houver dados específicos do utilizador na coleção `users/{userId}`, você também precisaria excluí-los.
        // Isso exigiria uma Cloud Function para ser seguro e eficiente.
        // Por exemplo:
        // const userSpecificDataRef = collection(db, `artifacts/${appId}/users/${userToActOn.id}/insumos`);
        // const snapshot = await getDocs(userSpecificDataRef);
        // snapshot.forEach(doc => deleteDoc(doc.ref));
        // Repetir para todas as coleções do utilizador.

      } catch (error) {
        console.error("Erro ao excluir utilizador:", error);
        showAppMessage('Erro ao Excluir Utilizador', `Não foi possível excluir o utilizador. Detalhes: ${error.message}`, 'error');
      } finally {
        setShowUserConfirmModal(false);
        setUserToActOn(null);
        setUserActionType('');
      }
    };

    const handleCancelUserAction = () => {
      setShowUserConfirmModal(false);
      setUserToActOn(null);
      setUserActionType('');
    };


    return (
      <div className="p-4">
        <h2 className="text-2xl font-bold text-green-800 mb-4">Gerenciar Utilizadores</h2>

        <div className="bg-white rounded-xl shadow-md overflow-hidden border border-green-200">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-green-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">E-mail</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nome</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Perfil</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {allUserProfiles.length === 0 ? (
                  <tr>
                    <td colSpan={4} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      Nenhum utilizador cadastrado.
                    </td>
                  </tr>
                ) : (
                  allUserProfiles.map(user => (
                    <tr key={user.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{user.email}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{user.name || 'N/A'}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {editingUser && editingUser.id === user.id ? (
                          <select
                            value={newRole}
                            onChange={(e) => setNewRole(e.target.value)}
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                          >
                            <option value="producao">Produção</option>
                            <option value="vendas">Vendas</option>
                            <option value="financeiro">Financeiro</option>
                            <option value="admin">Administrador</option>
                          </select>
                        ) : (
                          user.role.charAt(0).toUpperCase() + user.role.slice(1)
                        )}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        {editingUser && editingUser.id === user.id ? (
                          <>
                            <button
                              onClick={handleSaveUserRole}
                              className="text-green-600 hover:text-green-900 mr-3"
                              title="Salvar Perfil"
                            >
                              <Save size={18} />
                            </button>
                            <button
                              onClick={() => setEditingUser(null)}
                              className="text-gray-600 hover:text-gray-900"
                              title="Cancelar Edição"
                            >
                              <X size={18} />
                            </button>
                          </>
                        ) : (
                          <>
                            <button
                              onClick={() => handleEditUserRole(user)}
                              className="text-blue-600 hover:text-blue-900 mr-3"
                              title="Editar Perfil"
                            >
                              <Edit size={18} />
                            </button>
                            {currentUser && currentUser.uid !== user.id && ( // Não permite que o admin exclua a si mesmo
                              <button
                                onClick={() => handleDeleteUserRequest(user)}
                                className="text-red-600 hover:text-red-900"
                                title="Excluir Utilizador"
                              >
                                <Trash2 size={18} />
                              </button>
                            )}
                          </>
                        )}
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {showUserConfirmModal && (
          <ConfirmationModal
            message={confirmModalMessage}
            onConfirm={confirmModalAction}
            onCancel={handleCancelUserAction}
          />
        )}
      </div>
    );
  };


  // Renderização principal do App
  // Adicionado log para depuração do estado principal do App
  console.log("App Render - isAuthReady:", isAuthReady, "currentUser:", currentUser ? currentUser.uid : "null", "userRole:", userRole, "isLoading:", isLoading, "currentPage:", currentPage);

  // Se houver um erro global de inicialização do Firebase, exibe-o imediatamente
  if (firebaseInitDisplayError) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-red-100 text-red-800 p-4">
        <AlertTriangle size={64} className="mb-4" />
        <h2 className="text-2xl font-bold mb-2">Erro Crítico de Inicialização do Firebase</h2>
        <p className="text-lg text-center mb-6">Não foi possível conectar ao Firebase. Por favor, verifique a configuração do seu projeto e tente novamente.</p>
        <p className="text-sm text-center">Detalhes do erro: {firebaseInitDisplayError.message}</p>
      </div>
    );
  }

  // Se a autenticação não estiver pronta, mostra um loader
  if (!isAuthReady) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-500 to-lime-600">
        <Loader2 className="animate-spin text-white" size={64} />
        <p className="ml-4 text-xl text-white">Carregando autenticação...</p>
      </div>
    );
  }

  // Se não houver utilizador logado, mostra a página de login
  if (!currentUser) {
    return <LoginPage onLoginSuccess={() => setCurrentPage('dashboard')} />;
  }

  // Se houver utilizador mas o papel ainda não foi carregado, mostra um loader
  // Esta condição só será verdadeira brevemente se o perfil estiver sendo buscado
  if (userRole === null) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-500 to-lime-600">
        <Loader2 className="animate-spin text-white" size={64} />
        <p className="ml-4 text-xl text-white">Carregando perfil do utilizador...</p>
      </div>
    );
  }

  // Se estiver logado e o papel for 'null', significa que o perfil não foi encontrado/carregado corretamente
  // Esta condição é para o caso de um perfil ausente após a autenticação
  if (userRole === null && currentUser) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-red-100 text-red-800 p-4">
        <AlertTriangle size={64} className="mb-4" />
        <h2 className="text-2xl font-bold mb-2">Erro no Perfil do Utilizador</h2>
        <p className="text-lg text-center mb-6">Seu perfil de utilizador não pôde ser carregado ou está inválido. Por favor, entre em contacto com o suporte.</p>
        <button
          onClick={handleLogout}
          className="bg-red-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-300 flex items-center"
        >
          <LogOut size={18} className="mr-2" /> Sair
        </button>
      </div>
    );
  }


  return (
    <div className="min-h-screen bg-gray-100 font-sans antialiased flex flex-col">
      <style>
        {`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
          font-family: 'Inter', sans-serif;
        }
        .animate-fade-in-up {
          animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        `}
      </style>

      <Header title="Fábrica de Ração" />

      <main className="flex-grow pb-20">
        {isLoading ? (
          <div className="flex justify-center items-center h-full p-8">
            <Loader2 className="animate-spin text-green-700" size={48} />
            <p className="ml-4 text-lg text-gray-700">Carregando dados...</p>
          </div>
        ) : (
          <>
            {currentPage === 'dashboard' && <Dashboard />}
            {currentPage === 'insumos' && (userRole === 'admin') && (
              <ItemList
                title="Insumos"
                items={insumos}
                type="insumo"
                fields={[
                  { key: 'nome', label: 'Nome' },
                  { key: 'unidade', label: 'Unidade' },
                  { key: 'estoque', label: 'Estoque' },
                  { key: 'custo', label: 'Custo (R$)' },
                ]}
                onAdd={() => handleEdit(null, 'insumo')}
                onEdit={handleEdit}
                onDelete={handleDeleteRequest}
                canAdd={userRole === 'admin'}
                canEdit={userRole === 'admin'}
                canDelete={userRole === 'admin'}
              />
            )}
            {currentPage === 'produtos' && (userRole === 'admin' || userRole === 'producao') && (
              <ItemList
                title="Produtos"
                items={produtos}
                type="produto"
                fields={[
                  { key: 'nome', label: 'Nome' },
                  { key: 'unidade', label: 'Unidade' },
                  { key: 'estoque', label: 'Estoque' },
                  { key: 'preco', label: 'Preço (R$)' },
                ]}
                onAdd={() => handleEdit(null, 'produto')}
                onEdit={handleEdit}
                onDelete={handleDeleteRequest}
                canAdd={userRole === 'admin'}
                canEdit={userRole === 'admin'}
                canDelete={userRole === 'admin'}
              />
            )}
            {currentPage === 'producao' && (userRole === 'admin' || userRole === 'producao') && <PaginaProducao />}
            {currentPage === 'pedidos' && (userRole === 'admin' || userRole === 'vendas') && <PaginaPedidos />}
            {currentPage === 'fornecedores' && (userRole === 'admin' || userRole === 'financeiro') && (
              <ItemList
                title="Fornecedores"
                items={fornecedores}
                type="fornecedor"
                fields={[
                  { key: 'nome', label: 'Nome' },
                  { key: 'contato', label: 'Contato' },
                  { key: 'telefone', label: 'Telefone' },
                ]}
                onAdd={() => handleEdit(null, 'fornecedor')}
                onEdit={handleEdit}
                onDelete={handleDeleteRequest}
                canAdd={userRole === 'admin' || userRole === 'financeiro'}
                canEdit={userRole === 'admin' || userRole === 'financeiro'}
                canDelete={userRole === 'admin' || userRole === 'financeiro'}
              />
            )}
            {currentPage === 'clientes' && (userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro') && (
              <ItemList
                title="Clientes"
                items={clientes}
                type="cliente"
                fields={[
                  { key: 'nome', label: 'Nome' },
                  { key: 'contato', label: 'Contato' },
                  { key: 'telefone', label: 'Telefone' },
                ]}
                onAdd={() => handleEdit(null, 'cliente')}
                onEdit={handleEdit}
                onDelete={handleDeleteRequest}
                canAdd={userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro'}
                canEdit={userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro'}
                canDelete={userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro'}
              />
            )}
            {currentPage === 'movimentacao' && (userRole === 'admin') && <MovimentacaoEstoque />}
            {currentPage === 'financeiro' && (userRole === 'admin' || userRole === 'financeiro') && <PaginaFinanceiro />}
            {currentPage === 'clientesEmAtraso' && (userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro') && <PaginaClientesEmAtraso />}
            {currentPage === 'contasAPagarEmAberto' && (userRole === 'admin' || userRole === 'financeiro') && <PaginaContasAPagarEmAberto />}
            {currentPage === 'gerenciarUsuarios' && (userRole === 'admin') && <GerenciarUsuarios />}

            {/* Mensagem de acesso negado */}
            {((currentPage === 'insumos' && !(userRole === 'admin')) ||
              (currentPage === 'produtos' && !(userRole === 'admin' || userRole === 'producao')) ||
              (currentPage === 'producao' && !(userRole === 'admin' || userRole === 'producao')) ||
              (currentPage === 'pedidos' && !(userRole === 'admin' || userRole === 'vendas')) ||
              (currentPage === 'fornecedores' && !(userRole === 'admin' || userRole === 'financeiro')) ||
              (currentPage === 'clientes' && !(userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro')) ||
              (currentPage === 'movimentacao' && !(userRole === 'admin')) ||
              (currentPage === 'financeiro' && !(userRole === 'admin' || userRole === 'financeiro')) ||
              (currentPage === 'clientesEmAtraso' && !(userRole === 'admin' || userRole === 'vendas' || userRole === 'financeiro')) ||
              (currentPage === 'contasAPagarEmAberto' && !(userRole === 'admin' || userRole === 'financeiro')) ||
              (currentPage === 'gerenciarUsuarios' && !(userRole === 'admin'))
            ) && currentPage !== 'dashboard' && (
              <div className="p-8 text-center text-red-600 font-bold text-xl">
                Acesso negado. Você não tem permissão para visualizar este módulo com o perfil atual.
              </div>
            )}
          </>
        )}
      </main>

      {currentUser && <Navbar />} {/* Só mostra a navbar se estiver logado */}

      {/* Modal para Adicionar/Editar */}
      {formType && (
        <FormModal
          title={editingItem ? `Editar ${formType.charAt(0).toUpperCase() + formType.slice(1)}` : `Adicionar ${formType.charAt(0).toUpperCase() + formType.slice(1)}`}
          onClose={handleCancel}
        >
          {formType === 'insumo' && <InsumoForm />}
          {formType === 'produto' && <ProdutoForm />}
          {formType === 'fornecedor' && <FornecedorForm />}
          {formType === 'cliente' && <ClienteForm />}
          {formType === 'formula' && <FormulaForm />}
          {formType === 'ordemProducao' && <OrdemProducaoForm />}
          {formType === 'pedido' && <PedidoForm />}
          {formType === 'contaPagar' && <ContaPagarForm />}
          {formType === 'contaReceber' && <ContaReceberForm />}
        </FormModal>
      )}

      {/* Modal de Confirmação (para exclusão e produção/pedido) */}
      {showConfirmModal && (
        <ConfirmationModal
          message={confirmModalMessage}
          onConfirm={confirmModalAction}
          onCancel={() => setShowConfirmModal(false)}
        />
      )}

      {/* Modal de Mensagem (Sucesso/Erro/Info) */}
      {showMessageModal && (
        <MessageModal
          title={messageModalContent.title}
          message={messageModalContent.message}
          type={messageModalContent.type}
          onClose={() => setShowMessageModal(false)}
        />
      )}

      {/* Novo Modal para o Menu de Cadastro */}
      {showCadastroMenu && (
        <CadastroMenuModal onClose={() => setShowCadastroMenu(false)} />
      )}

      {/* Modal para Alterar Senha */}
      {showChangePasswordModal && currentUser && (
        <ChangePasswordForm
          currentUser={currentUser}
          showAppMessage={showAppMessage}
          onClose={() => setShowChangePasswordModal(false)}
        />
      )}

      {/* Modal para Esqueci a Senha */}
      {showForgotPasswordModal && (
        <ForgotPasswordForm
          auth={auth}
          showAppMessage={showAppMessage}
          onClose={() => setShowForgotPassword(false)}
        />
      )}
    </div>
  );
}

export default App;
